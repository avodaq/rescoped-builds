import { Injectable } from '@angular/core';
import { getItemPayload } from './cdk-datagrid.utils';
import * as i0 from "@angular/core";
export class CdkDatagridRuleManager {
    #globalItemRules;
    setGlobalRules(itemRules) {
        this.#globalItemRules = itemRules;
    }
    canRule(item, key, actionType) {
        return this.getRule(item, key, actionType);
    }
    canValidate(item, key, actionType) {
        return !!this.canRule(item, key, actionType)?.validate;
    }
    canRender(item, key, actionType) {
        return !!this.canRule(item, key, actionType)?.render;
    }
    canDisable(item, key, actionType) {
        return !!this.canRule(item, key, actionType)?.disable;
    }
    canAction(item, key, actionType) {
        return !!this.canRule(item, key, actionType)?.action;
    }
    getActionRule(item, key, actionType) {
        const action = this.getRule(item, key, actionType)?.action;
        if (!action) {
            return null;
        }
        if (typeof action?.cond === 'function' && action.cond() === true) {
            return action;
        }
        else if (typeof action?.cond === 'boolean' && action.cond === true) {
            return action;
        }
        else if (typeof action?.cond === 'undefined') {
            return action;
        }
        else {
            return null;
        }
    }
    applyRules(item, key, actionType, formControl, initialValue) {
        const rule = this.getRule(item, key, actionType);
        this.#applyRules(rule, formControl, initialValue);
    }
    #getItemRules(item) {
        return getItemPayload(item)?.rules;
    }
    #getGlobalRules(actionType) {
        return this.#globalItemRules?.[actionType];
    }
    getRule(item, key, actionType) {
        let rules = {};
        // has global one up (e.g. override/../disable) some rules?
        const parentGlobalRules = this.#getGlobalRules(actionType) || {};
        if (parentGlobalRules)
            rules = this.#mergeRules(parentGlobalRules, rules);
        // has global override rules?
        const globalOverrideRules = this.#getGlobalRules(actionType)?.overrides?.[key] || {};
        if (globalOverrideRules)
            rules = this.#mergeRules(globalOverrideRules, rules);
        // has item one up (e.g. override/../disable) some rules?
        const parentItemRules = this.#getItemRules(item) || {};
        if (parentItemRules)
            rules = this.#mergeRules(parentItemRules, rules);
        // has item override rules?
        const itemOverrideRules = this.#getItemRules(item)?.overrides?.[key] || {};
        if (itemOverrideRules)
            rules = this.#mergeRules(itemOverrideRules, rules);
        return rules;
    }
    #mergeRules(intoRule, fromRule) {
        return {
            validate: intoRule.validate ?? fromRule.validate,
            disable: intoRule.disable ?? fromRule.disable,
            render: intoRule.render ?? fromRule.render,
            placeholder: intoRule.placeholder ?? fromRule.placeholder,
            action: intoRule.action ?? fromRule.action,
        };
    }
    #applyRules(rules, formControl, initialValue) {
        if (formControl?.value !== initialValue) {
            rules?.render === undefined && formControl?.setValue(initialValue);
            rules?.render === true && formControl?.setValue(initialValue);
        }
        if (rules?.render === false && formControl?.value !== '') {
            formControl?.setValue('');
        }
        if (rules?.disable === true && !formControl?.disabled) {
            formControl?.disable();
        }
        if (!rules?.disable && !formControl?.enabled) {
            formControl?.enable();
        }
        if (!formControl?.disabled && (rules?.validate === false || rules?.validate === undefined)) {
            formControl?.setValidators([]);
            formControl?.setAsyncValidators([]);
            formControl?.updateValueAndValidity();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.9", ngImport: i0, type: CdkDatagridRuleManager, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.9", ngImport: i0, type: CdkDatagridRuleManager }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.9", ngImport: i0, type: CdkDatagridRuleManager, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLWRhdGFncmlkLXJ1bGUubWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9kYXRhZ3JpZC9zcmMvY2RrLWRhdGFncmlkLXJ1bGUubWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFJdEQsTUFBTSxPQUFPLHNCQUFzQjtJQUNqQyxnQkFBZ0IsQ0FBcUI7SUFFckMsY0FBYyxDQUFDLFNBQTRCO1FBQ3pDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxTQUFTLENBQUM7SUFDcEMsQ0FBQztJQUVELE9BQU8sQ0FDTCxJQUFVLEVBQ1YsR0FBWSxFQUNaLFVBQXNCO1FBRXRCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxXQUFXLENBQ1QsSUFBVSxFQUNWLEdBQVksRUFDWixVQUFzQjtRQUV0QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLEVBQUUsUUFBUSxDQUFDO0lBQ3pELENBQUM7SUFFRCxTQUFTLENBQ1AsSUFBVSxFQUNWLEdBQVksRUFDWixVQUFzQjtRQUV0QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLEVBQUUsTUFBTSxDQUFDO0lBQ3ZELENBQUM7SUFFRCxVQUFVLENBQ1IsSUFBVSxFQUNWLEdBQVksRUFDWixVQUFzQjtRQUV0QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLEVBQUUsT0FBTyxDQUFDO0lB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QUMsV0FBVyxFQUFFLFFBQVEsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLEtBQUssS0FBSyxJQUFJLEtBQUssRUFBRSxRQUFRLEtBQUssU0FBUyxDQUFDLEVBQUU7WUFDMUYsV0FBVyxFQUFFLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMvQixXQUFXLEVBQUUsa0JBQWtCLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEMsV0FBVyxFQUFFLHNCQUFzQixFQUFFLENBQUM7U0FDdkM7SUFDSCxDQUFDOzhHQXRKVSxzQkFBc0I7a0hBQXRCLHNCQUFzQjs7MkZBQXRCLHNCQUFzQjtrQkFEbEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEdsb2JhbFJ1bGVzLCBJdGVtQWN0aW9uVHlwZSwgSXRlbVJ1bGVzLCBSdWxlVHlwZXMgfSBmcm9tICcuL2Nkay1kYXRhZ3JpZC1kYXRhLm1hbmFnZXInO1xuaW1wb3J0IHsgZ2V0SXRlbVBheWxvYWQgfSBmcm9tICcuL2Nkay1kYXRhZ3JpZC51dGlscyc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDZGtEYXRhZ3JpZFJ1bGVNYW5hZ2VyPEl0ZW0+IHtcbiAgI2dsb2JhbEl0ZW1SdWxlcyE6IEdsb2JhbFJ1bGVzPEl0ZW0+O1xuXG4gIHNldEdsb2JhbFJ1bGVzKGl0ZW1SdWxlczogR2xvYmFsUnVsZXM8SXRlbT4pIHtcbiAgICB0aGlzLiNnbG9iYWxJdGVtUnVsZXMgPSBpdGVtUnVsZXM7XG4gIH1cblxuICBjYW5SdWxlPEl0ZW1LZXkgZXh0ZW5kcyBrZXlvZiBJdGVtLCBBY3Rpb25UeXBlIGV4dGVuZHMgSXRlbUFjdGlvblR5cGU+KFxuICAgIGl0ZW06IEl0ZW0sXG4gICAga2V5OiBJdGVtS2V5LFxuICAgIGFjdGlvblR5cGU6IEFjdGlvblR5cGUsXG4gICkge1xuICAgIHJldHVybiB0aGlzLmdldFJ1bGUoaXRlbSwga2V5LCBhY3Rpb25UeXBlKTtcbiAgfVxuXG4gIGNhblZhbGlkYXRlPEl0ZW1LZXkgZXh0ZW5kcyBrZXlvZiBJdGVtLCBBY3Rpb25UeXBlIGV4dGVuZHMgSXRlbUFjdGlvblR5cGU+KFxuICAgIGl0ZW06IEl0ZW0sXG4gICAga2V5OiBJdGVtS2V5LFxuICAgIGFjdGlvblR5cGU6IEFjdGlvblR5cGUsXG4gICkge1xuICAgIHJldHVybiAhIXRoaXMuY2FuUnVsZShpdGVtLCBrZXksIGFjdGlvblR5cGUpPy52YWxpZGF0ZTtcbiAgfVxuXG4gIGNhblJlbmRlcjxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbSwgQWN0aW9uVHlwZSBleHRlbmRzIEl0ZW1BY3Rpb25UeXBlPihcbiAgICBpdGVtOiBJdGVtLFxuICAgIGtleTogSXRlbUtleSxcbiAgICBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlLFxuICApIHtcbiAgICByZXR1cm4gISF0aGlzLmNhblJ1bGUoaXRlbSwga2V5LCBhY3Rpb25UeXBlKT8ucmVuZGVyO1xuICB9XG5cbiAgY2FuRGlzYWJsZTxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbSwgQWN0aW9uVHlwZSBleHRlbmRzIEl0ZW1BY3Rpb25UeXBlPihcbiAgICBpdGVtOiBJdGVtLFxuICAgIGtleTogSXRlbUtleSxcbiAgICBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlLFxuICApIHtcbiAgICByZXR1cm4gISF0aGlzLmNhblJ1bGUoaXRlbSwga2V5LCBhY3Rpb25UeXBlKT8uZGlzYWJsZTtcbiAgfVxuXG4gIGNhbkFjdGlvbjxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbSwgQWN0aW9uVHlwZSBleHRlbmRzIEl0ZW1BY3Rpb25UeXBlPihcbiAgICBpdGVtOiBJdGVtLFxuICAgIGtleTogSXRlbUtleSxcbiAgICBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlLFxuICApIHtcbiAgICByZXR1cm4gISF0aGlzLmNhblJ1bGUoaXRlbSwga2V5LCBhY3Rpb25UeXBlKT8uYWN0aW9uO1xuICB9XG5cbiAgZ2V0QWN0aW9uUnVsZTxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbSwgQWN0aW9uVHlwZSBleHRlbmRzIEl0ZW1BY3Rpb25UeXBlPihcbiAgICBpdGVtOiBJdGVtLFxuICAgIGtleTogSXRlbUtleSxcbiAgICBhY3Rpb25UeXBlOiBBY3Rpb25UeXBlLFxuICApIHtcbiAgICBjb25zdCBhY3Rpb24gPSB0aGlzLmdldFJ1bGUoaXRlbSwga2V5LCBhY3Rpb25UeXBlKT8uYWN0aW9uO1xuICAgIGlmICghYWN0aW9uKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGFjdGlvbj8uY29uZCA9PT0gJ2Z1bmN0aW9uJyAmJiBhY3Rpb24uY29uZCgpID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gYWN0aW9uO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFjdGlvbj8uY29uZCA9PT0gJ2Jvb2xlYW4nICYmIGFjdGlvbi5jb25kID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gYWN0aW9uO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFjdGlvbj8uY29uZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBhY3Rpb247XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFwcGx5UnVsZXM8SXRlbUtleSBleHRlbmRzIGtleW9mIEl0ZW0sIEFjdGlvblR5cGUgZXh0ZW5kcyBJdGVtQWN0aW9uVHlwZT4oXG4gICAgaXRlbTogSXRlbSxcbiAgICBrZXk6IEl0ZW1LZXksXG4gICAgYWN0aW9uVHlwZTogQWN0aW9uVHlwZSxcbiAgICBmb3JtQ29udHJvbDogQWJzdHJhY3RDb250cm9sIHwgbnVsbCxcbiAgICBpbml0aWFsVmFsdWU6IHN0cmluZyxcbiAgKSB7XG4gICAgY29uc3QgcnVsZSA9IHRoaXMuZ2V0UnVsZShpdGVtLCBrZXksIGFjdGlvblR5cGUpO1xuICAgIHRoaXMuI2FwcGx5UnVsZXMocnVsZSwgZm9ybUNvbnRyb2wsIGluaXRpYWxWYWx1ZSk7XG4gIH1cblxuICAjZ2V0SXRlbVJ1bGVzKGl0ZW06IEl0ZW0pIHtcbiAgICByZXR1cm4gZ2V0SXRlbVBheWxvYWQoaXRlbSk/LnJ1bGVzO1xuICB9XG5cbiAgI2dldEdsb2JhbFJ1bGVzPEFjdGlvblR5cGUgZXh0ZW5kcyBJdGVtQWN0aW9uVHlwZT4oYWN0aW9uVHlwZTogQWN0aW9uVHlwZSkge1xuICAgIHJldHVybiB0aGlzLiNnbG9iYWxJdGVtUnVsZXM/LlthY3Rpb25UeXBlXTtcbiAgfVxuXG4gIGdldFJ1bGU8SXRlbUtleSBleHRlbmRzIGtleW9mIEl0ZW0sIEFjdGlvblR5cGUgZXh0ZW5kcyBJdGVtQWN0aW9uVHlwZT4oXG4gICAgaXRlbTogSXRlbSxcbiAgICBrZXk6IEl0ZW1LZXksXG4gICAgYWN0aW9uVHlwZTogQWN0aW9uVHlwZSxcbiAgKSB7XG4gICAgbGV0IHJ1bGVzOiBSdWxlVHlwZXMgPSB7fTtcblxuICAgIC8vIGhhcyBnbG9iYWwgb25lIHVwIChlLmcuIG92ZXJyaWRlLy4uL2Rpc2FibGUpIHNvbWUgcnVsZXM/XG4gICAgY29uc3QgcGFyZW50R2xvYmFsUnVsZXMgPSB0aGlzLiNnZXRHbG9iYWxSdWxlcyhhY3Rpb25UeXBlKSB8fCB7fTtcbiAgICBpZiAocGFyZW50R2xvYmFsUnVsZXMpIHJ1bGVzID0gdGhpcy4jbWVyZ2VSdWxlcyhwYXJlbnRHbG9iYWxSdWxlcywgcnVsZXMpO1xuXG4gICAgLy8gaGFzIGdsb2JhbCBvdmVycmlkZSBydWxlcz9cbiAgICBjb25zdCBnbG9iYWxPdmVycmlkZVJ1bGVzID0gdGhpcy4jZ2V0R2xvYmFsUnVsZXMoYWN0aW9uVHlwZSk/Lm92ZXJyaWRlcz8uW2tleV0gfHwge307XG4gICAgaWYgKGdsb2JhbE92ZXJyaWRlUnVsZXMpIHJ1bGVzID0gdGhpcy4jbWVyZ2VSdWxlcyhnbG9iYWxPdmVycmlkZVJ1bGVzLCBydWxlcyk7XG5cbiAgICAvLyBoYXMgaXRlbSBvbmUgdXAgKGUuZy4gb3ZlcnJpZGUvLi4vZGlzYWJsZSkgc29tZSBydWxlcz9cbiAgICBjb25zdCBwYXJlbnRJdGVtUnVsZXMgPSB0aGlzLiNnZXRJdGVtUnVsZXMoaXRlbSkgfHwge307XG4gICAgaWYgKHBhcmVudEl0ZW1SdWxlcykgcnVsZXMgPSB0aGlzLiNtZXJnZVJ1bGVzKHBhcmVudEl0ZW1SdWxlcywgcnVsZXMpO1xuXG4gICAgLy8gaGFzIGl0ZW0gb3ZlcnJpZGUgcnVsZXM/XG4gICAgY29uc3QgaXRlbU92ZXJyaWRlUnVsZXMgPSB0aGlzLiNnZXRJdGVtUnVsZXMoaXRlbSk/Lm92ZXJyaWRlcz8uW2tleV0gfHwge307XG4gICAgaWYgKGl0ZW1PdmVycmlkZVJ1bGVzKSBydWxlcyA9IHRoaXMuI21lcmdlUnVsZXMoaXRlbU92ZXJyaWRlUnVsZXMsIHJ1bGVzKTtcblxuICAgIHJldHVybiBydWxlcztcbiAgfVxuXG4gICNtZXJnZVJ1bGVzKGludG9SdWxlOiBSdWxlVHlwZXMsIGZyb21SdWxlOiBSdWxlVHlwZXMpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdmFsaWRhdGU6IGludG9SdWxlLnZhbGlkYXRlID8/IGZyb21SdWxlLnZhbGlkYXRlLFxuICAgICAgZGlzYWJsZTogaW50b1J1bGUuZGlzYWJsZSA/PyBmcm9tUnVsZS5kaXNhYmxlLFxuICAgICAgcmVuZGVyOiBpbnRvUnVsZS5yZW5kZXIgPz8gZnJvbVJ1bGUucmVuZGVyLFxuICAgICAgcGxhY2Vob2xkZXI6IGludG9SdWxlLnBsYWNlaG9sZGVyID8/IGZyb21SdWxlLnBsYWNlaG9sZGVyLFxuICAgICAgYWN0aW9uOiBpbnRvUnVsZS5hY3Rpb24gPz8gZnJvbVJ1bGUuYWN0aW9uLFxuICAgIH07XG4gIH1cblxuICAjYXBwbHlSdWxlcyhcbiAgICBydWxlczogSXRlbVJ1bGVzPEl0ZW0+IHwgbnVsbCB8IHVuZGVmaW5lZCxcbiAgICBmb3JtQ29udHJvbDogQWJzdHJhY3RDb250cm9sIHwgbnVsbCxcbiAgICBpbml0aWFsVmFsdWU6IHN0cmluZyxcbiAgKSB7XG4gICAgaWYgKGZvcm1Db250cm9sPy52YWx1ZSAhPT0gaW5pdGlhbFZhbHVlKSB7XG4gICAgICBydWxlcz8ucmVuZGVyID09PSB1bmRlZmluZWQgJiYgZm9ybUNvbnRyb2w/LnNldFZhbHVlKGluaXRpYWxWYWx1ZSk7XG4gICAgICBydWxlcz8ucmVuZGVyID09PSB0cnVlICYmIGZvcm1Db250cm9sPy5zZXRWYWx1ZShpbml0aWFsVmFsdWUpO1xuICAgIH1cblxuICAgIGlmIChydWxlcz8ucmVuZGVyID09PSBmYWxzZSAmJiBmb3JtQ29udHJvbD8udmFsdWUgIT09ICcnKSB7XG4gICAgICBmb3JtQ29udHJvbD8uc2V0VmFsdWUoJycpO1xuICAgIH1cblxuICAgIGlmIChydWxlcz8uZGlzYWJsZSA9PT0gdHJ1ZSAmJiAhZm9ybUNvbnRyb2w/LmRpc2FibGVkKSB7XG4gICAgICBmb3JtQ29udHJvbD8uZGlzYWJsZSgpO1xuICAgIH1cblxuICAgIGlmICghcnVsZXM/LmRpc2FibGUgJiYgIWZvcm1Db250cm9sPy5lbmFibGVkKSB7XG4gICAgICBmb3JtQ29udHJvbD8uZW5hYmxlKCk7XG4gICAgfVxuXG4gICAgaWYgKCFmb3JtQ29udHJvbD8uZGlzYWJsZWQgJiYgKHJ1bGVzPy52YWxpZGF0ZSA9PT0gZmFsc2UgfHwgcnVsZXM/LnZhbGlkYXRlID09PSB1bmRlZmluZWQpKSB7XG4gICAgICBmb3JtQ29udHJvbD8uc2V0VmFsaWRhdG9ycyhbXSk7XG4gICAgICBmb3JtQ29udHJvbD8uc2V0QXN5bmNWYWxpZGF0b3JzKFtdKTtcbiAgICAgIGZvcm1Db250cm9sPy51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XG4gICAgfVxuICB9XG59XG4iXX0=