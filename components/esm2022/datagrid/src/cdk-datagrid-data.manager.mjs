import { Injectable } from '@angular/core';
import { getItemPayload, setItemPayload } from './cdk-datagrid.utils';
import { Subject } from 'rxjs';
import { startWith } from 'rxjs/operators';
import * as i0 from "@angular/core";
export const itemPayloadDefault = {
    id: '',
    index: 0,
    active: true,
    groupId: null,
    parent: false,
    collapsed: false,
    selected: false,
    filtered: false,
    actionType: 'row-single',
    rules: null,
};
export var ItemActionIndex;
(function (ItemActionIndex) {
    ItemActionIndex[ItemActionIndex["rowGlobal"] = -99] = "rowGlobal";
    ItemActionIndex[ItemActionIndex["rowGroup"] = -98] = "rowGroup";
    ItemActionIndex[ItemActionIndex["rowSingle"] = -97] = "rowSingle";
    ItemActionIndex[ItemActionIndex["rowSearchReplace"] = -96] = "rowSearchReplace";
})(ItemActionIndex || (ItemActionIndex = {}));
class CdkDatagridDataManager {
    constructor() {
        this.#valueChange$ = new Subject();
        this.valueChange$ = this.#valueChange$.pipe(startWith(null));
        this.#dataTableSlot = new Map();
        this.countSingleItems = 0;
        this.countGroupItems = 0;
        this.#originalData = [];
    }
    #valueChange$;
    #dataTableSlot;
    #dataSource;
    #originalData;
    set dataSource(dataSource) {
        this.#dataSource = dataSource;
        this.#originalData = dataSource.data.map((item, index) => this.#countActionType(setItemPayload(item, { index })));
    }
    get data() {
        return this.#originalData;
    }
    setValueChange(value) {
        this.#valueChange$.next(value);
    }
    splice(start, deleteCount = 0, items) {
        this.#originalData.splice(start, deleteCount, ...items);
        this.#originalData = this.cloneItemAll();
        this.#dataSource.data = this.#originalData;
    }
    delete(item, includeChildren = false) {
        const payload = getItemPayload(item);
        const _index = payload.index;
        const groupId = payload.groupId;
        const parent = payload.parent;
        this.#originalData = this.#originalData.filter(item => {
            const toNotDeleteItem = (!parent && getItemPayload(item).index !== _index) ||
                (includeChildren && parent && getItemPayload(item).groupId !== groupId);
            if (!toNotDeleteItem && typeof getItemPayload(item).groupId !== 'number') {
                console.error('ItemPayload.groupId is missing when includeChildren on', item);
                throw new Error('ItemPayload.groupId is required and must be a number!');
            }
            return toNotDeleteItem;
        });
        this.#originalData = this.cloneItemAll();
        this.#dataSource.data = this.#originalData;
    }
    /**
     * This method is useful when you want to add dynamic a runtime an item to the table.
     */
    addDataSlotItem(itemPayload, item) {
        const { id, actionType, active } = itemPayload;
        if (!id)
            throw new Error('id is required');
        if (!actionType)
            throw new Error('actionType is required');
        let _item = this.getDataTableItem(id);
        if (!_item) {
            _item = setItemPayload(_item ?? (item || {}), itemPayload);
            this.#dataTableSlot.set(id, _item);
        }
        else {
            _item = setItemPayload(_item, { active });
        }
        if (active) {
            this.#originalData.splice(0, 0, _item);
        }
        else if (!active) {
            const index = this.#dataSource.data.indexOf(_item);
            this.#originalData.splice(index, 1);
        }
        this.#dataSource.data = this.#originalData.filter(item => !getItemPayload(item).collapsed || getItemPayload(item).parent);
    }
    getDataTableItem(id) {
        return this.#dataTableSlot.get(id);
    }
    getChildItems(item) {
        const { groupId } = getItemPayload(item);
        return this.#originalData.filter(item => {
            const payload = getItemPayload(item);
            return (payload.groupId === groupId &&
                payload.parent === false &&
                payload.actionType === 'row-single');
        });
    }
    getSingleItems() {
        return this.#originalData.filter(item => {
            const { actionType } = getItemPayload(item);
            return actionType === 'row-single';
        });
    }
    getParentItem(item) {
        const { groupId } = getItemPayload(item);
        return this.#originalData.find(item => {
            const payload = getItemPayload(item);
            return payload.groupId === groupId && payload.parent === true;
        });
    }
    getGroupChildren(groupId) {
        return this.#originalData.filter(item => {
            const { groupId: _groupId, parent, actionType } = getItemPayload(item);
            return _groupId === groupId && !parent && actionType === 'row-single';
        });
    }
    setValue(key, value, item, affectedItemsFn) {
        const { actionType, groupId } = getItemPayload(item);
        if (actionType === 'row-single') {
            this.setSingleValue(item, key, value, affectedItemsFn);
        }
        else if (actionType === 'row-group' && typeof groupId === 'number' && groupId >= 0) {
            this.setGroupValues(key, value, groupId, affectedItemsFn);
        }
        else if (actionType === 'row-global') {
            this.setGlobalValues(key, value, affectedItemsFn);
        }
        else {
            throw new Error(`Unknown actionType: "${actionType}" or groupId: "${groupId}"`);
        }
        const valueChange = { key, value, actionType, groupId };
        this.#valueChange$.next(valueChange);
    }
    setItemByKeyValue(item, key, value) {
        if (!Object.getOwnPropertyDescriptor(item, key)) {
            throw new Error(`Invalid key: ${key.toString()} or no default item object is provided`);
        }
        item[key] = value;
    }
    setSingleValue(item, key, value, affectedItems) {
        this.setItemByKeyValue(item, key, value);
        affectedItems?.(getItemPayload(item));
    }
    setGroupValues(key, value, groupId, affectedItems) {
        this.#originalData.forEach(item => {
            const itemPayload = getItemPayload(item);
            if (itemPayload.groupId === groupId) {
                this.setItemByKeyValue(item, key, value);
                affectedItems?.(itemPayload);
            }
        });
    }
    setGlobalValues(key, value, affectedItems) {
        this.#originalData.forEach(Item => {
            const itemPayload = getItemPayload(Item);
            this.setItemByKeyValue(Item, key, value);
            affectedItems?.(itemPayload);
        });
    }
    toggleGroup(itemPayload) {
        this.#dataSource.data = this.#originalData.filter(item => {
            const _item = getItemPayload(item);
            if (itemPayload.groupId === _item.groupId) {
                item = setItemPayload(item, { collapsed: !_item.collapsed });
            }
            return !getItemPayload(item).collapsed || getItemPayload(item).parent;
        });
    }
    getItemByIndex(index) {
        const item = this.#originalData[index];
        if (!item) {
            throw new Error(`
        Item with index "${index}" not found.
        Hint: update the index value if you have added or removed items!
      `);
        }
        return this.#originalData[index];
    }
    getParentItemByGroupId(groupId) {
        const item = this.#originalData.find(item => {
            const _item = getItemPayload(item);
            return _item.groupId === groupId && _item.parent;
        });
        if (!item) {
            throw new Error(`Item with groupId "${groupId}" not found`);
        }
        return item;
    }
    cloneItemAll(itemPayload = {}) {
        return this.#originalData.map((item, index) => this.cloneItem(item, { ...itemPayload, index }));
    }
    cloneItem(item, itemPayload = {}) {
        const overrides = getItemPayload(item)?.rules?.overrides;
        const keyMaps = new Map();
        if (typeof overrides === 'object') {
            const overridesKeys = Object.keys(overrides);
            overridesKeys.forEach(key => {
                const action = getItemPayload(item)?.rules?.overrides?.[key]?.action;
                // action.componentType
                const component = action?.componentType;
                if (component) {
                    keyMaps.set(key, { ...keyMaps.get(key), component });
                    action.componentType = undefined;
                }
                // action.cond
                const cond = action?.cond;
                if (cond) {
                    keyMaps.set(key, { ...keyMaps.get(key), cond });
                    action.cond = undefined;
                }
                // action.transform
                const transform = action?.transform;
                if (transform) {
                    keyMaps.set(key, { ...keyMaps.get(key), transform });
                    action.transform = undefined;
                }
            });
        }
        item = structuredClone(item);
        keyMaps.forEach((componentType, key) => {
            const action = getItemPayload(item)?.rules?.overrides?.[key]?.action;
            if (action && componentType.component) {
                action.componentType = componentType.component;
            }
            if (action && componentType.cond) {
                action.cond = componentType.cond;
            }
            if (action && componentType.transform) {
                action.transform = componentType.transform;
            }
        });
        return setItemPayload(item, itemPayload);
    }
    #countActionType(item) {
        const actionType = getItemPayload(item).actionType;
        actionType === 'row-single' ? this.countSingleItems++ : null;
        actionType === 'row-group' ? this.countGroupItems++ : null;
        return item;
    }
    destroy() {
        this.#dataSource.data = [];
        this.#originalData = [];
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager }); }
}
export { CdkDatagridDataManager };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLWRhdGFncmlkLWRhdGEubWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9kYXRhZ3JpZC9zcmMvY2RrLWRhdGFncmlkLWRhdGEubWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBSzNDLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUF3QjtJQUNyRCxFQUFFLEVBQUUsRUFBRTtJQUNOLEtBQUssRUFBRSxDQUFDO0lBQ1IsTUFBTSxFQUFFLElBQUk7SUFDWixPQUFPLEVBQUUsSUFBSTtJQUNiLE1BQU0sRUFBRSxLQUFLO0lBQ2IsU0FBUyxFQUFFLEtBQUs7SUFDaEIsUUFBUSxFQUFFLEtBQUs7SUFDZixRQUFRLEVBQUUsS0FBSztJQUNmLFVBQVUsRUFBRSxZQUFZO0lBQ3hCLEtBQUssRUFBRSxJQUFJO0NBQ1osQ0FBQztBQU1GLE1BQU0sQ0FBTixJQUFZLGVBS1g7QUFMRCxXQUFZLGVBQWU7SUFDekIsaUVBQWUsQ0FBQTtJQUNmLCtEQUFRLENBQUE7SUFDUixpRUFBUyxDQUFBO0lBQ1QsK0VBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUxXLGVBQWUsS0FBZixlQUFlLFFBSzFCO0FBOERELE1BQ2Esc0JBQXNCO0lBRG5DO1FBT1csa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBc0IsQ0FBQztRQUNsRCxpQkFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXhELG1CQUFjLEdB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LE9BQU8sY0FBYyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsSUFBVTtRQUN6QixNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDO1FBQ25ELFVBQVUsS0FBSyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDN0QsVUFBVSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztJQUMxQixDQUFDOzhHQTdTVSxzQkFBc0I7a0hBQXRCLHNCQUFzQjs7U0FBdEIsc0JBQXNCOzJGQUF0QixzQkFBc0I7a0JBRGxDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXRJdGVtUGF5bG9hZCwgc2V0SXRlbVBheWxvYWQgfSBmcm9tICcuL2Nkay1kYXRhZ3JpZC51dGlscyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb21wb25lbnRUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgRGF0YWdyaWRWYWxpZGF0aW9uIH0gZnJvbSAnLi9jZGstZGF0YWdyaWQtZm9ybS1jb250cm9sLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBNYXRUYWJsZURhdGFTb3VyY2UgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC90YWJsZSc7XG5cbmV4cG9ydCBjb25zdCBpdGVtUGF5bG9hZERlZmF1bHQ6IEl0ZW1QYXlsb2FkPG9iamVjdD4gPSB7XG4gIGlkOiAnJyxcbiAgaW5kZXg6IDAsXG4gIGFjdGl2ZTogdHJ1ZSxcbiAgZ3JvdXBJZDogbnVsbCxcbiAgcGFyZW50OiBmYWxzZSxcbiAgY29sbGFwc2VkOiBmYWxzZSxcbiAgc2VsZWN0ZWQ6IGZhbHNlLFxuICBmaWx0ZXJlZDogZmFsc2UsXG4gIGFjdGlvblR5cGU6ICdyb3ctc2luZ2xlJyxcbiAgcnVsZXM6IG51bGwsXG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEhpZGRlbkl0ZW1QYXlsb2FkPEl0ZW0+IHtcbiAgXyRoaWRkZW5JdGVtUGF5bG9hZDogSXRlbVBheWxvYWQ8SXRlbT47XG59XG5cbmV4cG9ydCBlbnVtIEl0ZW1BY3Rpb25JbmRleCB7XG4gIHJvd0dsb2JhbCA9IC05OSxcbiAgcm93R3JvdXAsXG4gIHJvd1NpbmdsZSxcbiAgcm93U2VhcmNoUmVwbGFjZSxcbn1cblxuZXhwb3J0IHR5cGUgSXRlbUFjdGlvblR5cGUgPVxuICB8ICdyb3ctZ2xvYmFsJ1xuICB8ICdyb3ctZ3JvdXAnXG4gIHwgJ3Jvdy1zaW5nbGUnXG4gIHwgJ3Jvdy1zZWFyY2gtcmVwbGFjZSdcbiAgfCAncm93LWZpbHRlcidcbiAgfCAncm93LWVtcHR5JztcblxuZXhwb3J0IGludGVyZmFjZSBSdWxlVHlwZXMge1xuICB2YWxpZGF0ZT86IGJvb2xlYW47XG4gIC8vIEB0b2RvOiBoYXZlIHRvIGJlIGltcGxlbWVudGVkIGluIG9yZGVyIHRvIHBhc3MgdmFsaWRhdGlvbiB3aGlsZSBkYXRhIGFnZ3JlZ2F0aW9uXG4gIHZhbGlkYXRvcnM/OiBEYXRhZ3JpZFZhbGlkYXRpb247XG4gIGRpc2FibGU/OiBib29sZWFuO1xuICByZW5kZXI/OiBib29sZWFuO1xuICBwbGFjZWhvbGRlcj86IHN0cmluZztcbiAgYWN0aW9uPzoge1xuICAgIGNvbXBvbmVudFR5cGU/OiBDb21wb25lbnRUeXBlPHVua25vd24+O1xuICAgIGNvbXBvbmVudFBvc2l0aW9uPzogJ2JlZm9yZScgfCAnYWZ0ZXInIHwgJ292ZXJyaWRlJztcbiAgICBjb25kPzogYm9vbGVhbiB8ICgoKSA9PiBib29sZWFuKTtcbiAgICBkYXRhPzogdW5rbm93bjtcbiAgICB0cmFuc2Zvcm0/OiAoaXRlbTogYW55LCBrZXk6IGFueSwgdmFsdWU6IGFueSkgPT4gYW55O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEl0ZW1SdWxlczxJdGVtPiBleHRlbmRzIFJ1bGVUeXBlcyB7XG4gIG92ZXJyaWRlcz86IHtcbiAgICBbaXRlbUtleXMgaW4ga2V5b2YgSXRlbV0/OiBSdWxlVHlwZXM7XG4gIH07XG59XG5cbmV4cG9ydCB0eXBlIEdsb2JhbFJ1bGVzPEl0ZW0sIF9JdGVtQWN0aW9uVHlwZSBleHRlbmRzIEl0ZW1BY3Rpb25UeXBlID0gSXRlbUFjdGlvblR5cGU+ID0ge1xuICBbYWN0aW9uVHlwZSBpbiBfSXRlbUFjdGlvblR5cGVdPzogSXRlbVJ1bGVzPEl0ZW0+O1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBJdGVtUGF5bG9hZDxJdGVtPiB7XG4gIGlkOiBzdHJpbmc7IC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9haS9uYW5vaWRcbiAgaW5kZXg6IG51bWJlcjtcbiAgYWN0aXZlOiBib29sZWFuO1xuICBwYXJlbnQ6IGJvb2xlYW47XG4gIGNvbGxhcHNlZDogYm9vbGVhbiB8IG51bGw7XG4gIGdyb3VwSWQ6IG51bWJlciB8IG51bGw7XG4gIHNlbGVjdGVkOiBib29sZWFuO1xuICBmaWx0ZXJlZDogYm9vbGVhbjtcbiAgYWN0aW9uVHlwZTogSXRlbUFjdGlvblR5cGU7XG4gIHJ1bGVzOiBJdGVtUnVsZXM8SXRlbT4gfCBudWxsO1xufVxuXG5leHBvcnQgdHlwZSBJdGVtU2xvdElkID0gbnVtYmVyIHwgc3RyaW5nO1xuZXhwb3J0IHR5cGUgX0l0ZW1QYXlsb2FkPEl0ZW0+ID0gSXRlbVBheWxvYWQ8SXRlbT47XG5leHBvcnQgdHlwZSBJdGVtU2xvdDxJdGVtPiA9IE1hcDxJdGVtU2xvdElkLCBJdGVtPjtcbmV4cG9ydCB0eXBlIF9BZmZlY3RlZFBheWxvYWQ8SXRlbT4gPSAocGF5bG9hZDogSXRlbVBheWxvYWQ8SXRlbT4pID0+IHZvaWQ7XG5leHBvcnQgdHlwZSBHcm91cElkID0gSXRlbVBheWxvYWQ8b2JqZWN0PlsnZ3JvdXBJZCddO1xuXG5leHBvcnQgdHlwZSBWYWx1ZUNoYW5nZSA9IHtcbiAga2V5OiBzdHJpbmc7XG4gIHZhbHVlOiBzdHJpbmc7XG4gIGFjdGlvblR5cGU6IEl0ZW1BY3Rpb25UeXBlO1xuICBncm91cElkOiBHcm91cElkO1xufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENka0RhdGFncmlkRGF0YU1hbmFnZXI8XG4gIEl0ZW0sXG4gIEl0ZW1LZXkgZXh0ZW5kcyBrZXlvZiBJdGVtID0ga2V5b2YgSXRlbSxcbiAgSXRlbVBheWxvYWQgZXh0ZW5kcyBfSXRlbVBheWxvYWQ8SXRlbT4gPSBfSXRlbVBheWxvYWQ8SXRlbT4sXG4gIEFmZmVjdGVkUGF5bG9hZCBleHRlbmRzIF9BZmZlY3RlZFBheWxvYWQ8SXRlbT4gPSBfQWZmZWN0ZWRQYXlsb2FkPEl0ZW0+LFxuPiB7XG4gIHJlYWRvbmx5ICN2YWx1ZUNoYW5nZSQgPSBuZXcgU3ViamVjdDxWYWx1ZUNoYW5nZSB8IG51bGw+KCk7XG4gIHJlYWRvbmx5IHZhbHVlQ2hhbmdlJCA9IHRoaXMuI3ZhbHVlQ2hhbmdlJC5waXBlKHN0YXJ0V2l0aChudWxsKSk7XG5cbiAgcmVhZG9ubHkgI2RhdGFUYWJsZVNsb3Q6IEl0ZW1TbG90PEl0ZW0gfCBJdGVtUGF5bG9hZD4gPSBuZXcgTWFwPEl0ZW1TbG90SWQsIEl0ZW0+KCk7XG5cbiAgY291bnRTaW5nbGVJdGVtcyA9IDA7XG4gIGNvdW50R3JvdXBJdGVtcyA9IDA7XG5cbiAgI2RhdGFTb3VyY2UhOiBNYXRUYWJsZURhdGFTb3VyY2U8SXRlbT47XG5cbiAgI29yaWdpbmFsRGF0YTogSXRlbVtdID0gW107XG5cbiAgc2V0IGRhdGFTb3VyY2UoZGF0YVNvdXJjZTogTWF0VGFibGVEYXRhU291cmNlPEl0ZW0+KSB7XG4gICAgdGhpcy4jZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2U7XG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhID0gZGF0YVNvdXJjZS5kYXRhLm1hcCgoaXRlbSwgaW5kZXgpID0+XG4gICAgICB0aGlzLiNjb3VudEFjdGlvblR5cGUoc2V0SXRlbVBheWxvYWQoaXRlbSwgeyBpbmRleCB9KSksXG4gICAgKTtcbiAgfVxuXG4gIGdldCBkYXRhKCk6IEl0ZW1bXSB7XG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YTtcbiAgfVxuXG4gIHNldFZhbHVlQ2hhbmdlKHZhbHVlOiBWYWx1ZUNoYW5nZSB8IG51bGwpIHtcbiAgICB0aGlzLiN2YWx1ZUNoYW5nZSQubmV4dCh2YWx1ZSk7XG4gIH1cblxuICBzcGxpY2Uoc3RhcnQ6IG51bWJlciwgZGVsZXRlQ291bnQgPSAwLCBpdGVtczogSXRlbVtdKSB7XG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhLnNwbGljZShzdGFydCwgZGVsZXRlQ291bnQsIC4uLml0ZW1zKTtcbiAgICB0aGlzLiNvcmlnaW5hbERhdGEgPSB0aGlzLmNsb25lSXRlbUFsbCgpO1xuICAgIHRoaXMuI2RhdGFTb3VyY2UuZGF0YSA9IHRoaXMuI29yaWdpbmFsRGF0YTtcbiAgfVxuXG4gIGRlbGV0ZShpdGVtOiBJdGVtLCBpbmNsdWRlQ2hpbGRyZW4gPSBmYWxzZSkge1xuICAgIGNvbnN0IHBheWxvYWQgPSBnZXRJdGVtUGF5bG9hZChpdGVtKTtcbiAgICBjb25zdCBfaW5kZXggPSBwYXlsb2FkLmluZGV4O1xuICAgIGNvbnN0IGdyb3VwSWQgPSBwYXlsb2FkLmdyb3VwSWQ7XG4gICAgY29uc3QgcGFyZW50ID0gcGF5bG9hZC5wYXJlbnQ7XG5cbiAgICB0aGlzLiNvcmlnaW5hbERhdGEgPSB0aGlzLiNvcmlnaW5hbERhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgdG9Ob3REZWxldGVJdGVtID1cbiAgICAgICAgKCFwYXJlbnQgJiYgZ2V0SXRlbVBheWxvYWQoaXRlbSkuaW5kZXggIT09IF9pbmRleCkgfHxcbiAgICAgICAgKGluY2x1ZGVDaGlsZHJlbiAmJiBwYXJlbnQgJiYgZ2V0SXRlbVBheWxvYWQoaXRlbSkuZ3JvdXBJZCAhPT0gZ3JvdXBJZCk7XG5cbiAgICAgIGlmICghdG9Ob3REZWxldGVJdGVtICYmIHR5cGVvZiBnZXRJdGVtUGF5bG9hZChpdGVtKS5ncm91cElkICE9PSAnbnVtYmVyJykge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdJdGVtUGF5bG9hZC5ncm91cElkIGlzIG1pc3Npbmcgd2hlbiBpbmNsdWRlQ2hpbGRyZW4gb24nLCBpdGVtKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJdGVtUGF5bG9hZC5ncm91cElkIGlzIHJlcXVpcmVkIGFuZCBtdXN0IGJlIGEgbnVtYmVyIScpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdG9Ob3REZWxldGVJdGVtO1xuICAgIH0pO1xuXG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhID0gdGhpcy5jbG9uZUl0ZW1BbGwoKTtcbiAgICB0aGlzLiNkYXRhU291cmNlLmRhdGEgPSB0aGlzLiNvcmlnaW5hbERhdGE7XG4gIH1cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCB3aGVuIHlvdSB3YW50IHRvIGFkZCBkeW5hbWljIGEgcnVudGltZSBhbiBpdGVtIHRvIHRoZSB0YWJsZS5cbiAgICovXG4gIGFkZERhdGFTbG90SXRlbShpdGVtUGF5bG9hZDogUGFydGlhbDxJdGVtUGF5bG9hZD4sIGl0ZW0/OiBJdGVtKSB7XG4gICAgY29uc3QgeyBpZCwgYWN0aW9uVHlwZSwgYWN0aXZlIH0gPSBpdGVtUGF5bG9hZDtcblxuICAgIGlmICghaWQpIHRocm93IG5ldyBFcnJvcignaWQgaXMgcmVxdWlyZWQnKTtcbiAgICBpZiAoIWFjdGlvblR5cGUpIHRocm93IG5ldyBFcnJvcignYWN0aW9uVHlwZSBpcyByZXF1aXJlZCcpO1xuXG4gICAgbGV0IF9pdGVtID0gdGhpcy5nZXREYXRhVGFibGVJdGVtKGlkKTtcbiAgICBpZiAoIV9pdGVtKSB7XG4gICAgICBfaXRlbSA9IHNldEl0ZW1QYXlsb2FkKF9pdGVtID8/IChpdGVtIHx8ICh7fSBhcyBJdGVtKSksIGl0ZW1QYXlsb2FkKTtcbiAgICAgIHRoaXMuI2RhdGFUYWJsZVNsb3Quc2V0KGlkLCBfaXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9pdGVtID0gc2V0SXRlbVBheWxvYWQoX2l0ZW0sIHsgYWN0aXZlIH0pO1xuICAgIH1cblxuICAgIGlmIChhY3RpdmUpIHtcbiAgICAgIHRoaXMuI29yaWdpbmFsRGF0YS5zcGxpY2UoMCwgMCwgX2l0ZW0pO1xuICAgIH0gZWxzZSBpZiAoIWFjdGl2ZSkge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLiNkYXRhU291cmNlLmRhdGEuaW5kZXhPZihfaXRlbSk7XG4gICAgICB0aGlzLiNvcmlnaW5hbERhdGEuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG5cbiAgICB0aGlzLiNkYXRhU291cmNlLmRhdGEgPSB0aGlzLiNvcmlnaW5hbERhdGEuZmlsdGVyKFxuICAgICAgaXRlbSA9PiAhZ2V0SXRlbVBheWxvYWQoaXRlbSkuY29sbGFwc2VkIHx8IGdldEl0ZW1QYXlsb2FkKGl0ZW0pLnBhcmVudCxcbiAgICApO1xuICB9XG5cbiAgZ2V0RGF0YVRhYmxlSXRlbShpZDogSXRlbVNsb3RJZCkge1xuICAgIHJldHVybiB0aGlzLiNkYXRhVGFibGVTbG90LmdldChpZCkgYXMgSXRlbTtcbiAgfVxuXG4gIGdldENoaWxkSXRlbXMoaXRlbTogSXRlbSkge1xuICAgIGNvbnN0IHsgZ3JvdXBJZCB9ID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YS5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgICByZXR1cm4gKFxuICAgICAgICBwYXlsb2FkLmdyb3VwSWQgPT09IGdyb3VwSWQgJiZcbiAgICAgICAgcGF5bG9hZC5wYXJlbnQgPT09IGZhbHNlICYmXG4gICAgICAgIHBheWxvYWQuYWN0aW9uVHlwZSA9PT0gJ3Jvdy1zaW5nbGUnXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0U2luZ2xlSXRlbXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YS5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICBjb25zdCB7IGFjdGlvblR5cGUgfSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgcmV0dXJuIGFjdGlvblR5cGUgPT09ICdyb3ctc2luZ2xlJztcbiAgICB9KTtcbiAgfVxuXG4gIGdldFBhcmVudEl0ZW0oaXRlbTogSXRlbSkge1xuICAgIGNvbnN0IHsgZ3JvdXBJZCB9ID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YS5maW5kKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgcmV0dXJuIHBheWxvYWQuZ3JvdXBJZCA9PT0gZ3JvdXBJZCAmJiBwYXlsb2FkLnBhcmVudCA9PT0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEdyb3VwQ2hpbGRyZW4oZ3JvdXBJZDogR3JvdXBJZCkge1xuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgeyBncm91cElkOiBfZ3JvdXBJZCwgcGFyZW50LCBhY3Rpb25UeXBlIH0gPSBnZXRJdGVtUGF5bG9hZChpdGVtKTtcbiAgICAgIHJldHVybiBfZ3JvdXBJZCA9PT0gZ3JvdXBJZCAmJiAhcGFyZW50ICYmIGFjdGlvblR5cGUgPT09ICdyb3ctc2luZ2xlJztcbiAgICB9KTtcbiAgfVxuXG4gIHNldFZhbHVlPEl0ZW1LZXkgZXh0ZW5kcyBrZXlvZiBJdGVtPihcbiAgICBrZXk6IEl0ZW1LZXksXG4gICAgdmFsdWU6IEl0ZW1bSXRlbUtleV0sXG4gICAgaXRlbTogSXRlbSxcbiAgICBhZmZlY3RlZEl0ZW1zRm4/OiBBZmZlY3RlZFBheWxvYWQsXG4gICkge1xuICAgIGNvbnN0IHsgYWN0aW9uVHlwZSwgZ3JvdXBJZCB9ID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG5cbiAgICBpZiAoYWN0aW9uVHlwZSA9PT0gJ3Jvdy1zaW5nbGUnKSB7XG4gICAgICB0aGlzLnNldFNpbmdsZVZhbHVlKGl0ZW0sIGtleSwgdmFsdWUsIGFmZmVjdGVkSXRlbXNGbik7XG4gICAgfSBlbHNlIGlmIChhY3Rpb25UeXBlID09PSAncm93LWdyb3VwJyAmJiB0eXBlb2YgZ3JvdXBJZCA9PT0gJ251bWJlcicgJiYgZ3JvdXBJZCA+PSAwKSB7XG4gICAgICB0aGlzLnNldEdyb3VwVmFsdWVzKGtleSwgdmFsdWUsIGdyb3VwSWQsIGFmZmVjdGVkSXRlbXNGbik7XG4gICAgfSBlbHNlIGlmIChhY3Rpb25UeXBlID09PSAncm93LWdsb2JhbCcpIHtcbiAgICAgIHRoaXMuc2V0R2xvYmFsVmFsdWVzKGtleSwgdmFsdWUsIGFmZmVjdGVkSXRlbXNGbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBhY3Rpb25UeXBlOiBcIiR7YWN0aW9uVHlwZX1cIiBvciBncm91cElkOiBcIiR7Z3JvdXBJZH1cImApO1xuICAgIH1cblxuICAgIGNvbnN0IHZhbHVlQ2hhbmdlID0geyBrZXksIHZhbHVlLCBhY3Rpb25UeXBlLCBncm91cElkIH0gYXMgdW5rbm93biBhcyBWYWx1ZUNoYW5nZTtcbiAgICB0aGlzLiN2YWx1ZUNoYW5nZSQubmV4dCh2YWx1ZUNoYW5nZSk7XG4gIH1cblxuICBzZXRJdGVtQnlLZXlWYWx1ZTxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbT4oaXRlbTogSXRlbSwga2V5OiBJdGVtS2V5LCB2YWx1ZTogSXRlbVtJdGVtS2V5XSkge1xuICAgIGlmICghT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihpdGVtLCBrZXkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQga2V5OiAke2tleS50b1N0cmluZygpfSBvciBubyBkZWZhdWx0IGl0ZW0gb2JqZWN0IGlzIHByb3ZpZGVkYCk7XG4gICAgfVxuICAgIGl0ZW1ba2V5XSA9IHZhbHVlO1xuICB9XG4gIHNldFNpbmdsZVZhbHVlPEl0ZW1LZXkgZXh0ZW5kcyBrZXlvZiBJdGVtPihcbiAgICBpdGVtOiBJdGVtLFxuICAgIGtleTogSXRlbUtleSxcbiAgICB2YWx1ZTogSXRlbVtJdGVtS2V5XSxcbiAgICBhZmZlY3RlZEl0ZW1zPzogQWZmZWN0ZWRQYXlsb2FkLFxuICApIHtcbiAgICB0aGlzLnNldEl0ZW1CeUtleVZhbHVlKGl0ZW0sIGtleSwgdmFsdWUpO1xuICAgIGFmZmVjdGVkSXRlbXM/LihnZXRJdGVtUGF5bG9hZChpdGVtKSk7XG4gIH1cblxuICBzZXRHcm91cFZhbHVlczxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbT4oXG4gICAga2V5OiBJdGVtS2V5LFxuICAgIHZhbHVlOiBJdGVtW0l0ZW1LZXldLFxuICAgIGdyb3VwSWQ6IEdyb3VwSWQsXG4gICAgYWZmZWN0ZWRJdGVtcz86IEFmZmVjdGVkUGF5bG9hZCxcbiAgKSB7XG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBjb25zdCBpdGVtUGF5bG9hZCA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgaWYgKGl0ZW1QYXlsb2FkLmdyb3VwSWQgPT09IGdyb3VwSWQpIHtcbiAgICAgICAgdGhpcy5zZXRJdGVtQnlLZXlWYWx1ZShpdGVtLCBrZXksIHZhbHVlKTtcbiAgICAgICAgYWZmZWN0ZWRJdGVtcz8uKGl0ZW1QYXlsb2FkKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHNldEdsb2JhbFZhbHVlczxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbT4oXG4gICAga2V5OiBJdGVtS2V5LFxuICAgIHZhbHVlOiBJdGVtW0l0ZW1LZXldLFxuICAgIGFmZmVjdGVkSXRlbXM/OiBBZmZlY3RlZFBheWxvYWQsXG4gICkge1xuICAgIHRoaXMuI29yaWdpbmFsRGF0YS5mb3JFYWNoKEl0ZW0gPT4ge1xuICAgICAgY29uc3QgaXRlbVBheWxvYWQgPSBnZXRJdGVtUGF5bG9hZChJdGVtKTtcbiAgICAgIHRoaXMuc2V0SXRlbUJ5S2V5VmFsdWUoSXRlbSwga2V5LCB2YWx1ZSk7XG4gICAgICBhZmZlY3RlZEl0ZW1zPy4oaXRlbVBheWxvYWQpO1xuICAgIH0pO1xuICB9XG5cbiAgdG9nZ2xlR3JvdXAoaXRlbVBheWxvYWQ6IEl0ZW1QYXlsb2FkKSB7XG4gICAgdGhpcy4jZGF0YVNvdXJjZS5kYXRhID0gdGhpcy4jb3JpZ2luYWxEYXRhLmZpbHRlcihpdGVtID0+IHtcbiAgICAgIGNvbnN0IF9pdGVtID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgICBpZiAoaXRlbVBheWxvYWQuZ3JvdXBJZCA9PT0gX2l0ZW0uZ3JvdXBJZCkge1xuICAgICAgICBpdGVtID0gc2V0SXRlbVBheWxvYWQoaXRlbSwgeyBjb2xsYXBzZWQ6ICFfaXRlbS5jb2xsYXBzZWQgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gIWdldEl0ZW1QYXlsb2FkKGl0ZW0pLmNvbGxhcHNlZCB8fCBnZXRJdGVtUGF5bG9hZChpdGVtKS5wYXJlbnQ7XG4gICAgfSk7XG4gIH1cblxuICBnZXRJdGVtQnlJbmRleChpbmRleDogbnVtYmVyKSB7XG4gICAgY29uc3QgaXRlbSA9IHRoaXMuI29yaWdpbmFsRGF0YVtpbmRleF07XG4gICAgaWYgKCFpdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFxuICAgICAgICBJdGVtIHdpdGggaW5kZXggXCIke2luZGV4fVwiIG5vdCBmb3VuZC5cbiAgICAgICAgSGludDogdXBkYXRlIHRoZSBpbmRleCB2YWx1ZSBpZiB5b3UgaGF2ZSBhZGRlZCBvciByZW1vdmVkIGl0ZW1zIVxuICAgICAgYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YVtpbmRleF07XG4gIH1cblxuICBnZXRQYXJlbnRJdGVtQnlHcm91cElkKGdyb3VwSWQ6IG51bWJlcikge1xuICAgIGNvbnN0IGl0ZW0gPSB0aGlzLiNvcmlnaW5hbERhdGEuZmluZChpdGVtID0+IHtcbiAgICAgIGNvbnN0IF9pdGVtID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgICByZXR1cm4gX2l0ZW0uZ3JvdXBJZCA9PT0gZ3JvdXBJZCAmJiBfaXRlbS5wYXJlbnQ7XG4gICAgfSk7XG5cbiAgICBpZiAoIWl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSXRlbSB3aXRoIGdyb3VwSWQgXCIke2dyb3VwSWR9XCIgbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGl0ZW07XG4gIH1cblxuICBjbG9uZUl0ZW1BbGwoaXRlbVBheWxvYWQ6IFBhcnRpYWw8SXRlbVBheWxvYWQ+ID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy4jb3JpZ2luYWxEYXRhLm1hcCgoaXRlbSwgaW5kZXgpID0+XG4gICAgICB0aGlzLmNsb25lSXRlbShpdGVtLCB7IC4uLml0ZW1QYXlsb2FkLCBpbmRleCB9IGFzIFBhcnRpYWw8SXRlbVBheWxvYWQ+KSxcbiAgICApO1xuICB9XG5cbiAgY2xvbmVJdGVtKGl0ZW06IEl0ZW0sIGl0ZW1QYXlsb2FkOiBQYXJ0aWFsPEl0ZW1QYXlsb2FkPiA9IHt9KSB7XG4gICAgY29uc3Qgb3ZlcnJpZGVzID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk/LnJ1bGVzPy5vdmVycmlkZXM7XG4gICAgY29uc3Qga2V5TWFwczogTWFwPFxuICAgICAgSXRlbUtleSxcbiAgICAgIHtcbiAgICAgICAgY29tcG9uZW50PzogQ29tcG9uZW50VHlwZTx1bmtub3duPjtcbiAgICAgICAgY29uZD86ICgoKSA9PiBib29sZWFuKSB8IGJvb2xlYW47XG4gICAgICAgIHRyYW5zZm9ybT86IChpdGVtOiBhbnksIGtleTogYW55LCB2YWx1ZTogYW55KSA9PiBhbnk7XG4gICAgICB9XG4gICAgPiA9IG5ldyBNYXAoKTtcblxuICAgIGlmICh0eXBlb2Ygb3ZlcnJpZGVzID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3Qgb3ZlcnJpZGVzS2V5cyA9IDxJdGVtS2V5W10+T2JqZWN0LmtleXMob3ZlcnJpZGVzKTtcbiAgICAgIG92ZXJyaWRlc0tleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBjb25zdCBhY3Rpb24gPSBnZXRJdGVtUGF5bG9hZChpdGVtKT8ucnVsZXM/Lm92ZXJyaWRlcz8uW2tleV0/LmFjdGlvbjtcblxuICAgICAgICAvLyBhY3Rpb24uY29tcG9uZW50VHlwZVxuICAgICAgICBjb25zdCBjb21wb25lbnQgPSBhY3Rpb24/LmNvbXBvbmVudFR5cGU7XG4gICAgICAgIGlmIChjb21wb25lbnQpIHtcbiAgICAgICAgICBrZXlNYXBzLnNldChrZXksIHsgLi4ua2V5TWFwcy5nZXQoa2V5KSwgY29tcG9uZW50IH0pO1xuICAgICAgICAgIGFjdGlvbi5jb21wb25lbnRUeXBlID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWN0aW9uLmNvbmRcbiAgICAgICAgY29uc3QgY29uZCA9IGFjdGlvbj8uY29uZDtcbiAgICAgICAgaWYgKGNvbmQpIHtcbiAgICAgICAgICBrZXlNYXBzLnNldChrZXksIHsgLi4ua2V5TWFwcy5nZXQoa2V5KSwgY29uZCB9KTtcbiAgICAgICAgICBhY3Rpb24uY29uZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFjdGlvbi50cmFuc2Zvcm1cbiAgICAgICAgY29uc3QgdHJhbnNmb3JtID0gYWN0aW9uPy50cmFuc2Zvcm07XG4gICAgICAgIGlmICh0cmFuc2Zvcm0pIHtcbiAgICAgICAgICBrZXlNYXBzLnNldChrZXksIHsgLi4ua2V5TWFwcy5nZXQoa2V5KSwgdHJhbnNmb3JtIH0pO1xuICAgICAgICAgIGFjdGlvbi50cmFuc2Zvcm0gPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGl0ZW0gPSBzdHJ1Y3R1cmVkQ2xvbmUoaXRlbSk7XG5cbiAgICBrZXlNYXBzLmZvckVhY2goKGNvbXBvbmVudFR5cGUsIGtleSkgPT4ge1xuICAgICAgY29uc3QgYWN0aW9uID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk/LnJ1bGVzPy5vdmVycmlkZXM/LltrZXldPy5hY3Rpb247XG4gICAgICBpZiAoYWN0aW9uICYmIGNvbXBvbmVudFR5cGUuY29tcG9uZW50KSB7XG4gICAgICAgIGFjdGlvbi5jb21wb25lbnRUeXBlID0gY29tcG9uZW50VHlwZS5jb21wb25lbnQ7XG4gICAgICB9XG4gICAgICBpZiAoYWN0aW9uICYmIGNvbXBvbmVudFR5cGUuY29uZCkge1xuICAgICAgICBhY3Rpb24uY29uZCA9IGNvbXBvbmVudFR5cGUuY29uZDtcbiAgICAgIH1cbiAgICAgIGlmIChhY3Rpb24gJiYgY29tcG9uZW50VHlwZS50cmFuc2Zvcm0pIHtcbiAgICAgICAgYWN0aW9uLnRyYW5zZm9ybSA9IGNvbXBvbmVudFR5cGUudHJhbnNmb3JtO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNldEl0ZW1QYXlsb2FkKGl0ZW0sIGl0ZW1QYXlsb2FkKTtcbiAgfVxuXG4gICNjb3VudEFjdGlvblR5cGUoaXRlbTogSXRlbSkge1xuICAgIGNvbnN0IGFjdGlvblR5cGUgPSBnZXRJdGVtUGF5bG9hZChpdGVtKS5hY3Rpb25UeXBlO1xuICAgIGFjdGlvblR5cGUgPT09ICdyb3ctc2luZ2xlJyA/IHRoaXMuY291bnRTaW5nbGVJdGVtcysrIDogbnVsbDtcbiAgICBhY3Rpb25UeXBlID09PSAncm93LWdyb3VwJyA/IHRoaXMuY291bnRHcm91cEl0ZW1zKysgOiBudWxsO1xuICAgIHJldHVybiBpdGVtO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLiNkYXRhU291cmNlLmRhdGEgPSBbXTtcbiAgICB0aGlzLiNvcmlnaW5hbERhdGEgPSBbXTtcbiAgfVxufVxuIl19