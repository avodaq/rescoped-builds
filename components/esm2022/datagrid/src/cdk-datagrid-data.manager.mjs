import { Injectable } from '@angular/core';
import { getItemPayload, setItemPayload } from './cdk-datagrid.utils';
import { Subject } from 'rxjs';
import { startWith } from 'rxjs/operators';
import * as i0 from "@angular/core";
export const itemPayloadDefault = {
    id: '',
    index: 0,
    active: true,
    groupId: null,
    parent: false,
    collapsed: false,
    selected: false,
    filtered: false,
    actionType: 'row-single',
    rules: null,
};
export var ItemActionIndex;
(function (ItemActionIndex) {
    ItemActionIndex[ItemActionIndex["rowGlobal"] = -99] = "rowGlobal";
    ItemActionIndex[ItemActionIndex["rowGroup"] = -98] = "rowGroup";
    ItemActionIndex[ItemActionIndex["rowSingle"] = -97] = "rowSingle";
    ItemActionIndex[ItemActionIndex["rowSearchReplace"] = -96] = "rowSearchReplace";
})(ItemActionIndex || (ItemActionIndex = {}));
class CdkDatagridDataManager {
    constructor() {
        this.#valueChange$ = new Subject();
        this.valueChange$ = this.#valueChange$.pipe(startWith(null));
        this.#dataTableSlot = new Map();
        this.countSingleItems = 0;
        this.countGroupItems = 0;
        this.#originalData = [];
    }
    #valueChange$;
    #dataTableSlot;
    #dataSource;
    #originalData;
    set dataSource(dataSource) {
        this.#dataSource = dataSource;
        this.#originalData = dataSource.data.map((item, index) => this.#countActionType(setItemPayload(item, { index })));
    }
    get data() {
        return this.#originalData;
    }
    setValueChange(value) {
        this.#valueChange$.next(value);
    }
    splice(start, deleteCount = 0, items) {
        this.#originalData.splice(start, deleteCount, ...items);
        this.#originalData = this.cloneItemAll();
        this.#dataSource.data = this.#originalData;
    }
    delete(item, includeChildren = false) {
        const payload = getItemPayload(item);
        const _index = payload.index;
        const groupId = payload.groupId;
        const parent = payload.parent;
        this.#originalData = this.#originalData.filter(item => {
            const toNotDeleteItem = (!parent && getItemPayload(item).index !== _index) ||
                (includeChildren && parent && getItemPayload(item).groupId !== groupId);
            if (!toNotDeleteItem && typeof getItemPayload(item).groupId !== 'number') {
                console.error('ItemPayload.groupId is missing when includeChildren on', item);
                throw new Error('ItemPayload.groupId is required and must be a number!');
            }
            return toNotDeleteItem;
        });
        this.#originalData = this.cloneItemAll();
        this.#dataSource.data = this.#originalData;
    }
    /**
     * This method is useful when you want to add dynamic a runtime an item to the table.
     */
    addDataSlotItem(itemPayload, item) {
        const { id, actionType, active } = itemPayload;
        if (!id)
            throw new Error('id is required');
        if (!actionType)
            throw new Error('actionType is required');
        let _item = this.getDataTableItem(id);
        if (!_item) {
            _item = setItemPayload(_item ?? (item || {}), itemPayload);
            this.#dataTableSlot.set(id, _item);
        }
        else {
            _item = setItemPayload(_item, { active });
        }
        if (active) {
            this.#originalData.splice(0, 0, _item);
        }
        else if (!active) {
            const index = this.#dataSource.data.indexOf(_item);
            this.#originalData.splice(index, 1);
        }
        this.#dataSource.data = this.#originalData.filter(item => !getItemPayload(item).collapsed || getItemPayload(item).parent);
    }
    getDataTableItem(id) {
        return this.#dataTableSlot.get(id);
    }
    getChildItems(item) {
        const { groupId } = getItemPayload(item);
        return this.#originalData.filter(item => {
            const payload = getItemPayload(item);
            return (payload.groupId === groupId &&
                payload.parent === false &&
                payload.actionType === 'row-single');
        });
    }
    getSingleItems() {
        return this.#originalData.filter(item => {
            const { actionType } = getItemPayload(item);
            return actionType === 'row-single';
        });
    }
    getParentItem(item) {
        const { groupId } = getItemPayload(item);
        return this.#originalData.find(item => {
            const payload = getItemPayload(item);
            return payload.groupId === groupId && payload.parent === true;
        });
    }
    getGroupChildren(groupId) {
        return this.#originalData.filter(item => {
            const { groupId: _groupId, parent, actionType } = getItemPayload(item);
            return _groupId === groupId && !parent && actionType === 'row-single';
        });
    }
    setValue(key, value, item, affectedItemsFn) {
        const { actionType, groupId } = getItemPayload(item);
        if (actionType === 'row-single') {
            this.setSingleValue(item, key, value, affectedItemsFn);
        }
        else if (actionType === 'row-group' && typeof groupId === 'number' && groupId >= 0) {
            this.setGroupValues(key, value, groupId, affectedItemsFn);
        }
        else if (actionType === 'row-global') {
            this.setGlobalValues(key, value, affectedItemsFn);
        }
        else {
            throw new Error(`Unknown actionType: "${actionType}" or groupId: "${groupId}"`);
        }
        const valueChange = { key, value, actionType, groupId };
        this.#valueChange$.next(valueChange);
    }
    setItemByKeyValue(item, key, value) {
        if (!Object.getOwnPropertyDescriptor(item, key)) {
            throw new Error(`Invalid key: ${key.toString()} or no default item object is provided`);
        }
        item[key] = value;
    }
    setSingleValue(item, key, value, affectedItems) {
        this.setItemByKeyValue(item, key, value);
        affectedItems?.(getItemPayload(item));
    }
    setGroupValues(key, value, groupId, affectedItems) {
        this.#originalData.forEach(item => {
            const itemPayload = getItemPayload(item);
            if (itemPayload.groupId === groupId) {
                this.setItemByKeyValue(item, key, value);
                affectedItems?.(itemPayload);
            }
        });
    }
    setGlobalValues(key, value, affectedItems) {
        this.#originalData.forEach(Item => {
            const itemPayload = getItemPayload(Item);
            this.setItemByKeyValue(Item, key, value);
            affectedItems?.(itemPayload);
        });
    }
    toggleGroup(itemPayload) {
        this.#dataSource.data = this.#originalData.filter(item => {
            const _item = getItemPayload(item);
            if (itemPayload.groupId === _item.groupId) {
                item = setItemPayload(item, { collapsed: !_item.collapsed });
            }
            return !getItemPayload(item).collapsed || getItemPayload(item).parent;
        });
    }
    getItemByIndex(index) {
        const item = this.#originalData[index];
        if (!item) {
            throw new Error(`
        Item with index "${index}" not found.
        Hint: update the index value if you have added or removed items!
      `);
        }
        return this.#originalData[index];
    }
    getParentItemByGroupId(groupId) {
        const item = this.#originalData.find(item => {
            const _item = getItemPayload(item);
            return _item.groupId === groupId && _item.parent;
        });
        if (!item) {
            throw new Error(`Item with groupId "${groupId}" not found`);
        }
        return item;
    }
    cloneItemAll(itemPayload = {}) {
        return this.#originalData.map((item, index) => this.cloneItem(item, { ...itemPayload, index }));
    }
    cloneItem(item, itemPayload = {}) {
        const overrides = getItemPayload(item)?.rules?.overrides;
        const keyMaps = new Map();
        if (typeof overrides === 'object') {
            const overridesKeys = Object.keys(overrides);
            overridesKeys.forEach(key => {
                const action = getItemPayload(item)?.rules?.overrides?.[key]?.action;
                // action.componentType
                const component = action?.componentType;
                if (component) {
                    keyMaps.set(key, { ...keyMaps.get(key), component });
                    action.componentType = undefined;
                }
                // action.cond
                const cond = action?.cond;
                if (cond) {
                    keyMaps.set(key, { ...keyMaps.get(key), cond });
                    action.cond = undefined;
                }
                // action.transform
                const transform = action?.transform;
                if (transform) {
                    keyMaps.set(key, { ...keyMaps.get(key), transform });
                    action.transform = undefined;
                }
            });
        }
        item = structuredClone(item);
        keyMaps.forEach((componentType, key) => {
            const action = getItemPayload(item)?.rules?.overrides?.[key]?.action;
            if (action && componentType.component) {
                action.componentType = componentType.component;
            }
            if (action && componentType.cond) {
                action.cond = componentType.cond;
            }
            if (action && componentType.transform) {
                action.transform = componentType.transform;
            }
        });
        return setItemPayload(item, itemPayload);
    }
    #countActionType(item) {
        const actionType = getItemPayload(item).actionType;
        actionType === 'row-single' ? this.countSingleItems++ : null;
        actionType === 'row-group' ? this.countGroupItems++ : null;
        return item;
    }
    destroy() {
        this.#dataSource.data = [];
        this.#originalData = [];
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager }); }
}
export { CdkDatagridDataManager };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.6", ngImport: i0, type: CdkDatagridDataManager, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrLWRhdGFncmlkLWRhdGEubWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvY29tcG9uZW50cy9kYXRhZ3JpZC9zcmMvY2RrLWRhdGFncmlkLWRhdGEubWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBTzNDLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUF3QjtJQUNyRCxFQUFFLEVBQUUsRUFBRTtJQUNOLEtBQUssRUFBRSxDQUFDO0lBQ1IsTUFBTSxFQUFFLElBQUk7SUFDWixPQUFPLEVBQUUsSUFBSTtJQUNiLE1BQU0sRUFBRSxLQUFLO0lBQ2IsU0FBUyxFQUFFLEtBQUs7SUFDaEIsUUFBUSxFQUFFLEtBQUs7SUFDZixRQUFRLEVBQUUsS0FBSztJQUNmLFVBQVUsRUFBRSxZQUFZO0lBQ3hCLEtBQUssRUFBRSxJQUFJO0NBQ1osQ0FBQztBQU1GLE1BQU0sQ0FBTixJQUFZLGVBS1g7QUFMRCxXQUFZLGVBQWU7SUFDekIsaUVBQWUsQ0FBQTtJQUNmLCtEQUFRLENBQUE7SUFDUixpRUFBUyxDQUFBO0lBQ1QsK0VBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUxXLGVBQWUsS0FBZixlQUFlLFFBSzFCO0FBOERELE1BQ2Esc0JBQXNCO0lBRG5DO1FBT1csa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBc0IsQ0FBQztRQUNsRCxpQkFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXhELG1CQUFjLEdB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LE9BQU8sY0FBYyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsSUFBVTtRQUN6QixNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDO1FBQ25ELFVBQVUsS0FBSyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDN0QsVUFBVSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDM0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztJQUMxQixDQUFDOzhHQTdTVSxzQkFBc0I7a0hBQXRCLHNCQUFzQjs7U0FBdEIsc0JBQXNCOzJGQUF0QixzQkFBc0I7a0JBRGxDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXRJdGVtUGF5bG9hZCwgc2V0SXRlbVBheWxvYWQgfSBmcm9tICcuL2Nkay1kYXRhZ3JpZC51dGlscyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb21wb25lbnRUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgRGF0YWdyaWRWYWxpZGF0aW9uIH0gZnJvbSAnLi9jZGstZGF0YWdyaWQtZm9ybS1jb250cm9sLmRpcmVjdGl2ZSc7XG5cbi8vIE1EQ1xuaW1wb3J0IHsgTWF0VGFibGVEYXRhU291cmNlIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvdGFibGUnO1xuXG5leHBvcnQgY29uc3QgaXRlbVBheWxvYWREZWZhdWx0OiBJdGVtUGF5bG9hZDxvYmplY3Q+ID0ge1xuICBpZDogJycsXG4gIGluZGV4OiAwLFxuICBhY3RpdmU6IHRydWUsXG4gIGdyb3VwSWQ6IG51bGwsXG4gIHBhcmVudDogZmFsc2UsXG4gIGNvbGxhcHNlZDogZmFsc2UsXG4gIHNlbGVjdGVkOiBmYWxzZSxcbiAgZmlsdGVyZWQ6IGZhbHNlLFxuICBhY3Rpb25UeXBlOiAncm93LXNpbmdsZScsXG4gIHJ1bGVzOiBudWxsLFxufTtcblxuZXhwb3J0IGludGVyZmFjZSBIaWRkZW5JdGVtUGF5bG9hZDxJdGVtPiB7XG4gIF8kaGlkZGVuSXRlbVBheWxvYWQ6IEl0ZW1QYXlsb2FkPEl0ZW0+O1xufVxuXG5leHBvcnQgZW51bSBJdGVtQWN0aW9uSW5kZXgge1xuICByb3dHbG9iYWwgPSAtOTksXG4gIHJvd0dyb3VwLFxuICByb3dTaW5nbGUsXG4gIHJvd1NlYXJjaFJlcGxhY2UsXG59XG5cbmV4cG9ydCB0eXBlIEl0ZW1BY3Rpb25UeXBlID1cbiAgfCAncm93LWdsb2JhbCdcbiAgfCAncm93LWdyb3VwJ1xuICB8ICdyb3ctc2luZ2xlJ1xuICB8ICdyb3ctc2VhcmNoLXJlcGxhY2UnXG4gIHwgJ3Jvdy1maWx0ZXInXG4gIHwgJ3Jvdy1lbXB0eSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUnVsZVR5cGVzIHtcbiAgdmFsaWRhdGU/OiBib29sZWFuO1xuICAvLyBAdG9kbzogaGF2ZSB0byBiZSBpbXBsZW1lbnRlZCBpbiBvcmRlciB0byBwYXNzIHZhbGlkYXRpb24gd2hpbGUgZGF0YSBhZ2dyZWdhdGlvblxuICB2YWxpZGF0b3JzPzogRGF0YWdyaWRWYWxpZGF0aW9uO1xuICBkaXNhYmxlPzogYm9vbGVhbjtcbiAgcmVuZGVyPzogYm9vbGVhbjtcbiAgcGxhY2Vob2xkZXI/OiBzdHJpbmc7XG4gIGFjdGlvbj86IHtcbiAgICBjb21wb25lbnRUeXBlPzogQ29tcG9uZW50VHlwZTx1bmtub3duPjtcbiAgICBjb21wb25lbnRQb3NpdGlvbj86ICdiZWZvcmUnIHwgJ2FmdGVyJyB8ICdvdmVycmlkZSc7XG4gICAgY29uZD86IGJvb2xlYW4gfCAoKCkgPT4gYm9vbGVhbik7XG4gICAgZGF0YT86IHVua25vd247XG4gICAgdHJhbnNmb3JtPzogKGl0ZW06IGFueSwga2V5OiBhbnksIHZhbHVlOiBhbnkpID0+IGFueTtcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJdGVtUnVsZXM8SXRlbT4gZXh0ZW5kcyBSdWxlVHlwZXMge1xuICBvdmVycmlkZXM/OiB7XG4gICAgW2l0ZW1LZXlzIGluIGtleW9mIEl0ZW1dPzogUnVsZVR5cGVzO1xuICB9O1xufVxuXG5leHBvcnQgdHlwZSBHbG9iYWxSdWxlczxJdGVtLCBfSXRlbUFjdGlvblR5cGUgZXh0ZW5kcyBJdGVtQWN0aW9uVHlwZSA9IEl0ZW1BY3Rpb25UeXBlPiA9IHtcbiAgW2FjdGlvblR5cGUgaW4gX0l0ZW1BY3Rpb25UeXBlXT86IEl0ZW1SdWxlczxJdGVtPjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSXRlbVBheWxvYWQ8SXRlbT4ge1xuICBpZDogc3RyaW5nOyAvLyBodHRwczovL2dpdGh1Yi5jb20vYWkvbmFub2lkXG4gIGluZGV4OiBudW1iZXI7XG4gIGFjdGl2ZTogYm9vbGVhbjtcbiAgcGFyZW50OiBib29sZWFuO1xuICBjb2xsYXBzZWQ6IGJvb2xlYW4gfCBudWxsO1xuICBncm91cElkOiBudW1iZXIgfCBudWxsO1xuICBzZWxlY3RlZDogYm9vbGVhbjtcbiAgZmlsdGVyZWQ6IGJvb2xlYW47XG4gIGFjdGlvblR5cGU6IEl0ZW1BY3Rpb25UeXBlO1xuICBydWxlczogSXRlbVJ1bGVzPEl0ZW0+IHwgbnVsbDtcbn1cblxuZXhwb3J0IHR5cGUgSXRlbVNsb3RJZCA9IG51bWJlciB8IHN0cmluZztcbmV4cG9ydCB0eXBlIF9JdGVtUGF5bG9hZDxJdGVtPiA9IEl0ZW1QYXlsb2FkPEl0ZW0+O1xuZXhwb3J0IHR5cGUgSXRlbVNsb3Q8SXRlbT4gPSBNYXA8SXRlbVNsb3RJZCwgSXRlbT47XG5leHBvcnQgdHlwZSBfQWZmZWN0ZWRQYXlsb2FkPEl0ZW0+ID0gKHBheWxvYWQ6IEl0ZW1QYXlsb2FkPEl0ZW0+KSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgR3JvdXBJZCA9IEl0ZW1QYXlsb2FkPG9iamVjdD5bJ2dyb3VwSWQnXTtcblxuZXhwb3J0IHR5cGUgVmFsdWVDaGFuZ2UgPSB7XG4gIGtleTogc3RyaW5nO1xuICB2YWx1ZTogc3RyaW5nO1xuICBhY3Rpb25UeXBlOiBJdGVtQWN0aW9uVHlwZTtcbiAgZ3JvdXBJZDogR3JvdXBJZDtcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDZGtEYXRhZ3JpZERhdGFNYW5hZ2VyPFxuICBJdGVtLFxuICBJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbSA9IGtleW9mIEl0ZW0sXG4gIEl0ZW1QYXlsb2FkIGV4dGVuZHMgX0l0ZW1QYXlsb2FkPEl0ZW0+ID0gX0l0ZW1QYXlsb2FkPEl0ZW0+LFxuICBBZmZlY3RlZFBheWxvYWQgZXh0ZW5kcyBfQWZmZWN0ZWRQYXlsb2FkPEl0ZW0+ID0gX0FmZmVjdGVkUGF5bG9hZDxJdGVtPixcbj4ge1xuICByZWFkb25seSAjdmFsdWVDaGFuZ2UkID0gbmV3IFN1YmplY3Q8VmFsdWVDaGFuZ2UgfCBudWxsPigpO1xuICByZWFkb25seSB2YWx1ZUNoYW5nZSQgPSB0aGlzLiN2YWx1ZUNoYW5nZSQucGlwZShzdGFydFdpdGgobnVsbCkpO1xuXG4gIHJlYWRvbmx5ICNkYXRhVGFibGVTbG90OiBJdGVtU2xvdDxJdGVtIHwgSXRlbVBheWxvYWQ+ID0gbmV3IE1hcDxJdGVtU2xvdElkLCBJdGVtPigpO1xuXG4gIGNvdW50U2luZ2xlSXRlbXMgPSAwO1xuICBjb3VudEdyb3VwSXRlbXMgPSAwO1xuXG4gICNkYXRhU291cmNlITogTWF0VGFibGVEYXRhU291cmNlPEl0ZW0+O1xuXG4gICNvcmlnaW5hbERhdGE6IEl0ZW1bXSA9IFtdO1xuXG4gIHNldCBkYXRhU291cmNlKGRhdGFTb3VyY2U6IE1hdFRhYmxlRGF0YVNvdXJjZTxJdGVtPikge1xuICAgIHRoaXMuI2RhdGFTb3VyY2UgPSBkYXRhU291cmNlO1xuICAgIHRoaXMuI29yaWdpbmFsRGF0YSA9IGRhdGFTb3VyY2UuZGF0YS5tYXAoKGl0ZW0sIGluZGV4KSA9PlxuICAgICAgdGhpcy4jY291bnRBY3Rpb25UeXBlKHNldEl0ZW1QYXlsb2FkKGl0ZW0sIHsgaW5kZXggfSkpLFxuICAgICk7XG4gIH1cblxuICBnZXQgZGF0YSgpOiBJdGVtW10ge1xuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGE7XG4gIH1cblxuICBzZXRWYWx1ZUNoYW5nZSh2YWx1ZTogVmFsdWVDaGFuZ2UgfCBudWxsKSB7XG4gICAgdGhpcy4jdmFsdWVDaGFuZ2UkLm5leHQodmFsdWUpO1xuICB9XG5cbiAgc3BsaWNlKHN0YXJ0OiBudW1iZXIsIGRlbGV0ZUNvdW50ID0gMCwgaXRlbXM6IEl0ZW1bXSkge1xuICAgIHRoaXMuI29yaWdpbmFsRGF0YS5zcGxpY2Uoc3RhcnQsIGRlbGV0ZUNvdW50LCAuLi5pdGVtcyk7XG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhID0gdGhpcy5jbG9uZUl0ZW1BbGwoKTtcbiAgICB0aGlzLiNkYXRhU291cmNlLmRhdGEgPSB0aGlzLiNvcmlnaW5hbERhdGE7XG4gIH1cblxuICBkZWxldGUoaXRlbTogSXRlbSwgaW5jbHVkZUNoaWxkcmVuID0gZmFsc2UpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgY29uc3QgX2luZGV4ID0gcGF5bG9hZC5pbmRleDtcbiAgICBjb25zdCBncm91cElkID0gcGF5bG9hZC5ncm91cElkO1xuICAgIGNvbnN0IHBhcmVudCA9IHBheWxvYWQucGFyZW50O1xuXG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhID0gdGhpcy4jb3JpZ2luYWxEYXRhLmZpbHRlcihpdGVtID0+IHtcbiAgICAgIGNvbnN0IHRvTm90RGVsZXRlSXRlbSA9XG4gICAgICAgICghcGFyZW50ICYmIGdldEl0ZW1QYXlsb2FkKGl0ZW0pLmluZGV4ICE9PSBfaW5kZXgpIHx8XG4gICAgICAgIChpbmNsdWRlQ2hpbGRyZW4gJiYgcGFyZW50ICYmIGdldEl0ZW1QYXlsb2FkKGl0ZW0pLmdyb3VwSWQgIT09IGdyb3VwSWQpO1xuXG4gICAgICBpZiAoIXRvTm90RGVsZXRlSXRlbSAmJiB0eXBlb2YgZ2V0SXRlbVBheWxvYWQoaXRlbSkuZ3JvdXBJZCAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignSXRlbVBheWxvYWQuZ3JvdXBJZCBpcyBtaXNzaW5nIHdoZW4gaW5jbHVkZUNoaWxkcmVuIG9uJywgaXRlbSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSXRlbVBheWxvYWQuZ3JvdXBJZCBpcyByZXF1aXJlZCBhbmQgbXVzdCBiZSBhIG51bWJlciEnKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRvTm90RGVsZXRlSXRlbTtcbiAgICB9KTtcblxuICAgIHRoaXMuI29yaWdpbmFsRGF0YSA9IHRoaXMuY2xvbmVJdGVtQWxsKCk7XG4gICAgdGhpcy4jZGF0YVNvdXJjZS5kYXRhID0gdGhpcy4jb3JpZ2luYWxEYXRhO1xuICB9XG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyB1c2VmdWwgd2hlbiB5b3Ugd2FudCB0byBhZGQgZHluYW1pYyBhIHJ1bnRpbWUgYW4gaXRlbSB0byB0aGUgdGFibGUuXG4gICAqL1xuICBhZGREYXRhU2xvdEl0ZW0oaXRlbVBheWxvYWQ6IFBhcnRpYWw8SXRlbVBheWxvYWQ+LCBpdGVtPzogSXRlbSkge1xuICAgIGNvbnN0IHsgaWQsIGFjdGlvblR5cGUsIGFjdGl2ZSB9ID0gaXRlbVBheWxvYWQ7XG5cbiAgICBpZiAoIWlkKSB0aHJvdyBuZXcgRXJyb3IoJ2lkIGlzIHJlcXVpcmVkJyk7XG4gICAgaWYgKCFhY3Rpb25UeXBlKSB0aHJvdyBuZXcgRXJyb3IoJ2FjdGlvblR5cGUgaXMgcmVxdWlyZWQnKTtcblxuICAgIGxldCBfaXRlbSA9IHRoaXMuZ2V0RGF0YVRhYmxlSXRlbShpZCk7XG4gICAgaWYgKCFfaXRlbSkge1xuICAgICAgX2l0ZW0gPSBzZXRJdGVtUGF5bG9hZChfaXRlbSA/PyAoaXRlbSB8fCAoe30gYXMgSXRlbSkpLCBpdGVtUGF5bG9hZCk7XG4gICAgICB0aGlzLiNkYXRhVGFibGVTbG90LnNldChpZCwgX2l0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBfaXRlbSA9IHNldEl0ZW1QYXlsb2FkKF9pdGVtLCB7IGFjdGl2ZSB9KTtcbiAgICB9XG5cbiAgICBpZiAoYWN0aXZlKSB7XG4gICAgICB0aGlzLiNvcmlnaW5hbERhdGEuc3BsaWNlKDAsIDAsIF9pdGVtKTtcbiAgICB9IGVsc2UgaWYgKCFhY3RpdmUpIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy4jZGF0YVNvdXJjZS5kYXRhLmluZGV4T2YoX2l0ZW0pO1xuICAgICAgdGhpcy4jb3JpZ2luYWxEYXRhLnNwbGljZShpbmRleCwgMSk7XG4gICAgfVxuXG4gICAgdGhpcy4jZGF0YVNvdXJjZS5kYXRhID0gdGhpcy4jb3JpZ2luYWxEYXRhLmZpbHRlcihcbiAgICAgIGl0ZW0gPT4gIWdldEl0ZW1QYXlsb2FkKGl0ZW0pLmNvbGxhcHNlZCB8fCBnZXRJdGVtUGF5bG9hZChpdGVtKS5wYXJlbnQsXG4gICAgKTtcbiAgfVxuXG4gIGdldERhdGFUYWJsZUl0ZW0oaWQ6IEl0ZW1TbG90SWQpIHtcbiAgICByZXR1cm4gdGhpcy4jZGF0YVRhYmxlU2xvdC5nZXQoaWQpIGFzIEl0ZW07XG4gIH1cblxuICBnZXRDaGlsZEl0ZW1zKGl0ZW06IEl0ZW0pIHtcbiAgICBjb25zdCB7IGdyb3VwSWQgfSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgcGF5bG9hZC5ncm91cElkID09PSBncm91cElkICYmXG4gICAgICAgIHBheWxvYWQucGFyZW50ID09PSBmYWxzZSAmJlxuICAgICAgICBwYXlsb2FkLmFjdGlvblR5cGUgPT09ICdyb3ctc2luZ2xlJ1xuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFNpbmdsZUl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgeyBhY3Rpb25UeXBlIH0gPSBnZXRJdGVtUGF5bG9hZChpdGVtKTtcbiAgICAgIHJldHVybiBhY3Rpb25UeXBlID09PSAncm93LXNpbmdsZSc7XG4gICAgfSk7XG4gIH1cblxuICBnZXRQYXJlbnRJdGVtKGl0ZW06IEl0ZW0pIHtcbiAgICBjb25zdCB7IGdyb3VwSWQgfSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGEuZmluZChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBnZXRJdGVtUGF5bG9hZChpdGVtKTtcbiAgICAgIHJldHVybiBwYXlsb2FkLmdyb3VwSWQgPT09IGdyb3VwSWQgJiYgcGF5bG9hZC5wYXJlbnQgPT09IHRydWU7XG4gICAgfSk7XG4gIH1cblxuICBnZXRHcm91cENoaWxkcmVuKGdyb3VwSWQ6IEdyb3VwSWQpIHtcbiAgICByZXR1cm4gdGhpcy4jb3JpZ2luYWxEYXRhLmZpbHRlcihpdGVtID0+IHtcbiAgICAgIGNvbnN0IHsgZ3JvdXBJZDogX2dyb3VwSWQsIHBhcmVudCwgYWN0aW9uVHlwZSB9ID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk7XG4gICAgICByZXR1cm4gX2dyb3VwSWQgPT09IGdyb3VwSWQgJiYgIXBhcmVudCAmJiBhY3Rpb25UeXBlID09PSAncm93LXNpbmdsZSc7XG4gICAgfSk7XG4gIH1cblxuICBzZXRWYWx1ZTxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbT4oXG4gICAga2V5OiBJdGVtS2V5LFxuICAgIHZhbHVlOiBJdGVtW0l0ZW1LZXldLFxuICAgIGl0ZW06IEl0ZW0sXG4gICAgYWZmZWN0ZWRJdGVtc0ZuPzogQWZmZWN0ZWRQYXlsb2FkLFxuICApIHtcbiAgICBjb25zdCB7IGFjdGlvblR5cGUsIGdyb3VwSWQgfSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuXG4gICAgaWYgKGFjdGlvblR5cGUgPT09ICdyb3ctc2luZ2xlJykge1xuICAgICAgdGhpcy5zZXRTaW5nbGVWYWx1ZShpdGVtLCBrZXksIHZhbHVlLCBhZmZlY3RlZEl0ZW1zRm4pO1xuICAgIH0gZWxzZSBpZiAoYWN0aW9uVHlwZSA9PT0gJ3Jvdy1ncm91cCcgJiYgdHlwZW9mIGdyb3VwSWQgPT09ICdudW1iZXInICYmIGdyb3VwSWQgPj0gMCkge1xuICAgICAgdGhpcy5zZXRHcm91cFZhbHVlcyhrZXksIHZhbHVlLCBncm91cElkLCBhZmZlY3RlZEl0ZW1zRm4pO1xuICAgIH0gZWxzZSBpZiAoYWN0aW9uVHlwZSA9PT0gJ3Jvdy1nbG9iYWwnKSB7XG4gICAgICB0aGlzLnNldEdsb2JhbFZhbHVlcyhrZXksIHZhbHVlLCBhZmZlY3RlZEl0ZW1zRm4pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gYWN0aW9uVHlwZTogXCIke2FjdGlvblR5cGV9XCIgb3IgZ3JvdXBJZDogXCIke2dyb3VwSWR9XCJgKTtcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZUNoYW5nZSA9IHsga2V5LCB2YWx1ZSwgYWN0aW9uVHlwZSwgZ3JvdXBJZCB9IGFzIHVua25vd24gYXMgVmFsdWVDaGFuZ2U7XG4gICAgdGhpcy4jdmFsdWVDaGFuZ2UkLm5leHQodmFsdWVDaGFuZ2UpO1xuICB9XG5cbiAgc2V0SXRlbUJ5S2V5VmFsdWU8SXRlbUtleSBleHRlbmRzIGtleW9mIEl0ZW0+KGl0ZW06IEl0ZW0sIGtleTogSXRlbUtleSwgdmFsdWU6IEl0ZW1bSXRlbUtleV0pIHtcbiAgICBpZiAoIU9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoaXRlbSwga2V5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGtleTogJHtrZXkudG9TdHJpbmcoKX0gb3Igbm8gZGVmYXVsdCBpdGVtIG9iamVjdCBpcyBwcm92aWRlZGApO1xuICAgIH1cbiAgICBpdGVtW2tleV0gPSB2YWx1ZTtcbiAgfVxuICBzZXRTaW5nbGVWYWx1ZTxJdGVtS2V5IGV4dGVuZHMga2V5b2YgSXRlbT4oXG4gICAgaXRlbTogSXRlbSxcbiAgICBrZXk6IEl0ZW1LZXksXG4gICAgdmFsdWU6IEl0ZW1bSXRlbUtleV0sXG4gICAgYWZmZWN0ZWRJdGVtcz86IEFmZmVjdGVkUGF5bG9hZCxcbiAgKSB7XG4gICAgdGhpcy5zZXRJdGVtQnlLZXlWYWx1ZShpdGVtLCBrZXksIHZhbHVlKTtcbiAgICBhZmZlY3RlZEl0ZW1zPy4oZ2V0SXRlbVBheWxvYWQoaXRlbSkpO1xuICB9XG5cbiAgc2V0R3JvdXBWYWx1ZXM8SXRlbUtleSBleHRlbmRzIGtleW9mIEl0ZW0+KFxuICAgIGtleTogSXRlbUtleSxcbiAgICB2YWx1ZTogSXRlbVtJdGVtS2V5XSxcbiAgICBncm91cElkOiBHcm91cElkLFxuICAgIGFmZmVjdGVkSXRlbXM/OiBBZmZlY3RlZFBheWxvYWQsXG4gICkge1xuICAgIHRoaXMuI29yaWdpbmFsRGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaXRlbVBheWxvYWQgPSBnZXRJdGVtUGF5bG9hZChpdGVtKTtcbiAgICAgIGlmIChpdGVtUGF5bG9hZC5ncm91cElkID09PSBncm91cElkKSB7XG4gICAgICAgIHRoaXMuc2V0SXRlbUJ5S2V5VmFsdWUoaXRlbSwga2V5LCB2YWx1ZSk7XG4gICAgICAgIGFmZmVjdGVkSXRlbXM/LihpdGVtUGF5bG9hZCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZXRHbG9iYWxWYWx1ZXM8SXRlbUtleSBleHRlbmRzIGtleW9mIEl0ZW0+KFxuICAgIGtleTogSXRlbUtleSxcbiAgICB2YWx1ZTogSXRlbVtJdGVtS2V5XSxcbiAgICBhZmZlY3RlZEl0ZW1zPzogQWZmZWN0ZWRQYXlsb2FkLFxuICApIHtcbiAgICB0aGlzLiNvcmlnaW5hbERhdGEuZm9yRWFjaChJdGVtID0+IHtcbiAgICAgIGNvbnN0IGl0ZW1QYXlsb2FkID0gZ2V0SXRlbVBheWxvYWQoSXRlbSk7XG4gICAgICB0aGlzLnNldEl0ZW1CeUtleVZhbHVlKEl0ZW0sIGtleSwgdmFsdWUpO1xuICAgICAgYWZmZWN0ZWRJdGVtcz8uKGl0ZW1QYXlsb2FkKTtcbiAgICB9KTtcbiAgfVxuXG4gIHRvZ2dsZUdyb3VwKGl0ZW1QYXlsb2FkOiBJdGVtUGF5bG9hZCkge1xuICAgIHRoaXMuI2RhdGFTb3VyY2UuZGF0YSA9IHRoaXMuI29yaWdpbmFsRGF0YS5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICBjb25zdCBfaXRlbSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgaWYgKGl0ZW1QYXlsb2FkLmdyb3VwSWQgPT09IF9pdGVtLmdyb3VwSWQpIHtcbiAgICAgICAgaXRlbSA9IHNldEl0ZW1QYXlsb2FkKGl0ZW0sIHsgY29sbGFwc2VkOiAhX2l0ZW0uY29sbGFwc2VkIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuICFnZXRJdGVtUGF5bG9hZChpdGVtKS5jb2xsYXBzZWQgfHwgZ2V0SXRlbVBheWxvYWQoaXRlbSkucGFyZW50O1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0SXRlbUJ5SW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgIGNvbnN0IGl0ZW0gPSB0aGlzLiNvcmlnaW5hbERhdGFbaW5kZXhdO1xuICAgIGlmICghaXRlbSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBcbiAgICAgICAgSXRlbSB3aXRoIGluZGV4IFwiJHtpbmRleH1cIiBub3QgZm91bmQuXG4gICAgICAgIEhpbnQ6IHVwZGF0ZSB0aGUgaW5kZXggdmFsdWUgaWYgeW91IGhhdmUgYWRkZWQgb3IgcmVtb3ZlZCBpdGVtcyFcbiAgICAgIGApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLiNvcmlnaW5hbERhdGFbaW5kZXhdO1xuICB9XG5cbiAgZ2V0UGFyZW50SXRlbUJ5R3JvdXBJZChncm91cElkOiBudW1iZXIpIHtcbiAgICBjb25zdCBpdGVtID0gdGhpcy4jb3JpZ2luYWxEYXRhLmZpbmQoaXRlbSA9PiB7XG4gICAgICBjb25zdCBfaXRlbSA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pO1xuICAgICAgcmV0dXJuIF9pdGVtLmdyb3VwSWQgPT09IGdyb3VwSWQgJiYgX2l0ZW0ucGFyZW50O1xuICAgIH0pO1xuXG4gICAgaWYgKCFpdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEl0ZW0gd2l0aCBncm91cElkIFwiJHtncm91cElkfVwiIG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIHJldHVybiBpdGVtO1xuICB9XG5cbiAgY2xvbmVJdGVtQWxsKGl0ZW1QYXlsb2FkOiBQYXJ0aWFsPEl0ZW1QYXlsb2FkPiA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuI29yaWdpbmFsRGF0YS5tYXAoKGl0ZW0sIGluZGV4KSA9PlxuICAgICAgdGhpcy5jbG9uZUl0ZW0oaXRlbSwgeyAuLi5pdGVtUGF5bG9hZCwgaW5kZXggfSBhcyBQYXJ0aWFsPEl0ZW1QYXlsb2FkPiksXG4gICAgKTtcbiAgfVxuXG4gIGNsb25lSXRlbShpdGVtOiBJdGVtLCBpdGVtUGF5bG9hZDogUGFydGlhbDxJdGVtUGF5bG9hZD4gPSB7fSkge1xuICAgIGNvbnN0IG92ZXJyaWRlcyA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pPy5ydWxlcz8ub3ZlcnJpZGVzO1xuICAgIGNvbnN0IGtleU1hcHM6IE1hcDxcbiAgICAgIEl0ZW1LZXksXG4gICAgICB7XG4gICAgICAgIGNvbXBvbmVudD86IENvbXBvbmVudFR5cGU8dW5rbm93bj47XG4gICAgICAgIGNvbmQ/OiAoKCkgPT4gYm9vbGVhbikgfCBib29sZWFuO1xuICAgICAgICB0cmFuc2Zvcm0/OiAoaXRlbTogYW55LCBrZXk6IGFueSwgdmFsdWU6IGFueSkgPT4gYW55O1xuICAgICAgfVxuICAgID4gPSBuZXcgTWFwKCk7XG5cbiAgICBpZiAodHlwZW9mIG92ZXJyaWRlcyA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IG92ZXJyaWRlc0tleXMgPSA8SXRlbUtleVtdPk9iamVjdC5rZXlzKG92ZXJyaWRlcyk7XG4gICAgICBvdmVycmlkZXNLZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgY29uc3QgYWN0aW9uID0gZ2V0SXRlbVBheWxvYWQoaXRlbSk/LnJ1bGVzPy5vdmVycmlkZXM/LltrZXldPy5hY3Rpb247XG5cbiAgICAgICAgLy8gYWN0aW9uLmNvbXBvbmVudFR5cGVcbiAgICAgICAgY29uc3QgY29tcG9uZW50ID0gYWN0aW9uPy5jb21wb25lbnRUeXBlO1xuICAgICAgICBpZiAoY29tcG9uZW50KSB7XG4gICAgICAgICAga2V5TWFwcy5zZXQoa2V5LCB7IC4uLmtleU1hcHMuZ2V0KGtleSksIGNvbXBvbmVudCB9KTtcbiAgICAgICAgICBhY3Rpb24uY29tcG9uZW50VHlwZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFjdGlvbi5jb25kXG4gICAgICAgIGNvbnN0IGNvbmQgPSBhY3Rpb24/LmNvbmQ7XG4gICAgICAgIGlmIChjb25kKSB7XG4gICAgICAgICAga2V5TWFwcy5zZXQoa2V5LCB7IC4uLmtleU1hcHMuZ2V0KGtleSksIGNvbmQgfSk7XG4gICAgICAgICAgYWN0aW9uLmNvbmQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhY3Rpb24udHJhbnNmb3JtXG4gICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IGFjdGlvbj8udHJhbnNmb3JtO1xuICAgICAgICBpZiAodHJhbnNmb3JtKSB7XG4gICAgICAgICAga2V5TWFwcy5zZXQoa2V5LCB7IC4uLmtleU1hcHMuZ2V0KGtleSksIHRyYW5zZm9ybSB9KTtcbiAgICAgICAgICBhY3Rpb24udHJhbnNmb3JtID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpdGVtID0gc3RydWN0dXJlZENsb25lKGl0ZW0pO1xuXG4gICAga2V5TWFwcy5mb3JFYWNoKChjb21wb25lbnRUeXBlLCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IGdldEl0ZW1QYXlsb2FkKGl0ZW0pPy5ydWxlcz8ub3ZlcnJpZGVzPy5ba2V5XT8uYWN0aW9uO1xuICAgICAgaWYgKGFjdGlvbiAmJiBjb21wb25lbnRUeXBlLmNvbXBvbmVudCkge1xuICAgICAgICBhY3Rpb24uY29tcG9uZW50VHlwZSA9IGNvbXBvbmVudFR5cGUuY29tcG9uZW50O1xuICAgICAgfVxuICAgICAgaWYgKGFjdGlvbiAmJiBjb21wb25lbnRUeXBlLmNvbmQpIHtcbiAgICAgICAgYWN0aW9uLmNvbmQgPSBjb21wb25lbnRUeXBlLmNvbmQ7XG4gICAgICB9XG4gICAgICBpZiAoYWN0aW9uICYmIGNvbXBvbmVudFR5cGUudHJhbnNmb3JtKSB7XG4gICAgICAgIGFjdGlvbi50cmFuc2Zvcm0gPSBjb21wb25lbnRUeXBlLnRyYW5zZm9ybTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBzZXRJdGVtUGF5bG9hZChpdGVtLCBpdGVtUGF5bG9hZCk7XG4gIH1cblxuICAjY291bnRBY3Rpb25UeXBlKGl0ZW06IEl0ZW0pIHtcbiAgICBjb25zdCBhY3Rpb25UeXBlID0gZ2V0SXRlbVBheWxvYWQoaXRlbSkuYWN0aW9uVHlwZTtcbiAgICBhY3Rpb25UeXBlID09PSAncm93LXNpbmdsZScgPyB0aGlzLmNvdW50U2luZ2xlSXRlbXMrKyA6IG51bGw7XG4gICAgYWN0aW9uVHlwZSA9PT0gJ3Jvdy1ncm91cCcgPyB0aGlzLmNvdW50R3JvdXBJdGVtcysrIDogbnVsbDtcbiAgICByZXR1cm4gaXRlbTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy4jZGF0YVNvdXJjZS5kYXRhID0gW107XG4gICAgdGhpcy4jb3JpZ2luYWxEYXRhID0gW107XG4gIH1cbn1cbiJdfQ==